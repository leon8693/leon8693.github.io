<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[唯一的真理]]></title>
  <link href="http://leon8693.github.io/atom.xml" rel="self"/>
  <link href="http://leon8693.github.io/"/>
  <updated>2014-11-17T17:03:04+08:00</updated>
  <id>http://leon8693.github.io/</id>
  <author>
    <name><![CDATA[leon]]></name>
    <email><![CDATA[bolatuleon@hotmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[zabbix 2.4.1 Low Level Discovery模板 (五)]]></title>
    <link href="http://leon8693.github.io/blog/2014/11/17/zabbix-2-dot-4-1-lldmo-ban-5/"/>
    <updated>2014-11-17T16:21:00+08:00</updated>
    <id>http://leon8693.github.io/blog/2014/11/17/zabbix-2-dot-4-1-lldmo-ban-5</id>
    <content type="html"><![CDATA[<h2>Low Level Discovery模板</h2>

<p>这里将收集lld各类模板</p>

<blockquote><p>1.<a href="https://github.com/jizhang/zabbix-templates/tree/master/mysql-v2">Mysql</a> <br/>
2.<a href="https://github.com/leon8693/zabbix_template/tree/master/Redis">Redis</a></p></blockquote>

<!-- more -->

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[octopress 加快博客访问速度]]></title>
    <link href="http://leon8693.github.io/blog/2014/11/07/octopress-jia-kuai-bo-ke-fang-wen-su-du/"/>
    <updated>2014-11-07T11:08:00+08:00</updated>
    <id>http://leon8693.github.io/blog/2014/11/07/octopress-jia-kuai-bo-ke-fang-wen-su-du</id>
    <content type="html"><![CDATA[<h2>增加Octopress访问速度</h2>

<p>大家会发现搭建的Octopress访问的非常慢,除非翻墙才能访问的快<br/>
其中原因就是googleapis.com相关的东西造成我们访问缓慢(GFW懂的入)<br/>
这边感谢大神张吉给的意见<a href="https://github.com/jizhang/jizhang.github.com/commit/340817e45b1c3a0e6c0fcb09c5d153141358c59d">传送门</a> <br/>
虽然大神写了,我这里还是补刀一下,自己记录一下</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cat source/_includes/head.html
</span><span class='line'>
</span><span class='line'>  &lt;script src="http://leon8693.github.io/javascripts/modernizr-2.0.js"&gt;&lt;/script&gt;
</span><span class='line'>  &lt;!-- &lt;script src="http://leon8693.github.io//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"&gt;&lt;/script&gt;                                                                                                                           
</span><span class='line'>  &lt;script&gt;!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))&lt;/script&gt; --&gt;
</span><span class='line'>  &lt;script src="http://leon8693.github.io/javascripts/libs/jquery.min.js"&gt;&lt;/script&gt;
</span><span class='line'>  &lt;script src="http://leon8693.github.io/javascripts/octopress.js" type="text/javascript"&gt;&lt;/script&gt;
</span><span class='line'>  &lt;script&gt;
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cat source/_includes/custom/head.html
</span><span class='line'>
</span><span class='line'>&lt;!--Fonts from Google"s Web font directory at http://google.com/webfonts --&gt;
</span><span class='line'>&lt;!-- &lt;link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css"&gt;  --&gt;
</span><span class='line'>&lt;!-- &lt;link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css"&gt; --&gt;      </span></code></pre></td></tr></table></div></figure>


<p>好了就到这,再访问一下blog是不是很快: )</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[zabbix 2.4.1 自定义邮件报警 (四)]]></title>
    <link href="http://leon8693.github.io/blog/2014/10/24/zabbix-2-dot-4-1-zi-ding-yi-you-jian-bao-jing-4/"/>
    <updated>2014-10-24T16:31:00+08:00</updated>
    <id>http://leon8693.github.io/blog/2014/10/24/zabbix-2-dot-4-1-zi-ding-yi-you-jian-bao-jing-4</id>
    <content type="html"><![CDATA[<h2>自定义邮件报警</h2>

<p>前面几步完成后,发现报警机制没有,本章开始说报警,这边我取一个最简单的方式而且又方便</p>

<h4>创建报警邮件脚本</h4>

<p>下载<a href="http://caspian.dotconf.net/menu/Software/SendEmail/sendEmail-v1.55.tar.gz">SendEmail</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#将sendEmail复制到/usr/local/bin/下
</span><span class='line'>#编写邮件脚本
</span><span class='line'>vim /mnt/www/zabbix/share/zabbix/alertscripts/sendEmail.sh
</span><span class='line'>#!/bin/bash
</span><span class='line'>MAIL="/usr/local/bin/sendEmail"
</span><span class='line'>USER_LIST="$1"          #收件人列表
</span><span class='line'>SUBJECT="$2"            #主题
</span><span class='line'>MESSAGE="$3"            #内容
</span><span class='line'>SMTP="smtp.gmail.com"
</span><span class='line'>USERNAME="aaa@gmail.com"
</span><span class='line'>USERPASSWD="123456"
</span><span class='line'>$MAIL -f aaa@gmail.com -t $USER_LIST -u $SUBJECT -m $MESSAGE -s $SMTP -xu $USERNAME -xp $USERPASSWD</span></code></pre></td></tr></table></div></figure>


<!-- more -->


<h4>添加脚本邮件</h4>

<p>选择管理&mdash;>示警媒介类型&mdash;>创建媒体类型&mdash;>如图将脚本名称加入类型选择脚本 <br/>
<img src="http://leon8693.github.io/images/blog_img/zabbixmail01.png" alt="zabbixmail01" />
<img src="http://leon8693.github.io/images/blog_img/zabbixmail02.png" alt="zabbixmail02" /></p>

<h4>添加用户邮件设置</h4>

<p>设置用户关联,管理&mdash;>用户 <br/>
<img src="http://leon8693.github.io/images/blog_img/zabbixmail03.png" alt="zabbixmail03" />
选择使用的用户并且编辑设置 <br/>
<img src="http://leon8693.github.io/images/blog_img/zabbixmail04.png" alt="zabbixmail04" />
<img src="http://leon8693.github.io/images/blog_img/zabbixmail05.png" alt="zabbixmail05" />
<img src="http://leon8693.github.io/images/blog_img/zabbixmail06.png" alt="zabbixmail06" /></p>

<h4>报警动作</h4>

<p>组态&mdash;>动作&mdash;创建动作(根据图片进行设置) <br/>
<img src="http://leon8693.github.io/images/blog_img/zabbixmail07.png" alt="zabbixmail07" />
<img src="http://leon8693.github.io/images/blog_img/zabbixmail08.png" alt="zabbixmail08" /></p>

<p>PS:900指邮件发送的间隔,1-0指发送邮件的步骤,我这边设置的是无限次,并且自己添加需要发送的用户组或者用户 <br/>
<img src="http://leon8693.github.io/images/blog_img/zabbixmail09.png" alt="zabbixmail09" /></p>

<h4>测试</h4>

<p>PS:动作1黄色代表正在操作中,当变成绿色则代表发送成功 <br/>
<img src="http://leon8693.github.io/images/blog_img/zabbixmail10.png" alt="zabbixmail10" />
<img src="http://leon8693.github.io/images/blog_img/zabbixmail11.png" alt="zabbixmail11" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[zabbix 2.4.1 自动发现 (三)]]></title>
    <link href="http://leon8693.github.io/blog/2014/10/22/zabbix-2-dot-4-1-zi-dong-fa-xian-3/"/>
    <updated>2014-10-22T16:22:00+08:00</updated>
    <id>http://leon8693.github.io/blog/2014/10/22/zabbix-2-dot-4-1-zi-dong-fa-xian-3</id>
    <content type="html"><![CDATA[<p>zabbix有个很有用的特性,就是自动发现,可以自动找已经启用zabbix agent的服务器并且对这些服务器进行添加监控以及分组等工作</p>

<h2>自动发现</h2>

<p>首先添加发现规则 <br/>
点击&mdash;组态&mdash;探索<br/>
<img src="http://leon8693.github.io/images/blog_img/zabbixat01.png" alt="zabbixat01" /></p>

<!-- more -->


<p>点击右侧的创建发现规则<br/>
<img src="http://leon8693.github.io/images/blog_img/zabbixat02.png" alt="zabbixat02" /></p>

<p>根据图片进行匹配IP范围,并且设定通过zabbix代理进行验证<br/>
<img src="http://leon8693.github.io/images/blog_img/zabbixat03.png" alt="zabbixat03" /></p>

<p>增加发现的主机后的操作 <br/>
<img src="http://leon8693.github.io/images/blog_img/zabbixat04.png" alt="zabbixat04" /></p>

<p>事件源选择探索&mdash;>点击创建动作&mdash;>取名称&mdash;>选择匹配范围&mdash;>选择动作操作 <br/>
<img src="http://leon8693.github.io/images/blog_img/zabbixat05.png" alt="zabbixat05" />
<img src="http://leon8693.github.io/images/blog_img/zabbixat06.png" alt="zabbixat06" />
<img src="http://leon8693.github.io/images/blog_img/zabbixat07.png" alt="zabbixat07" /></p>

<p>点击检测中查看最下面探索状态<br/>
<img src="http://leon8693.github.io/images/blog_img/zabbixat07.png" alt="zabbixat07" /></p>

<p>看到如图所示说明已经成功！<br/>
PS:网卡流量和磁盘空间需要等一段时间agent会推送给server<br/>
<img src="http://leon8693.github.io/images/blog_img/zabbixat08.png" alt="zabbixat08" />
<img src="http://leon8693.github.io/images/blog_img/zabbixat09.png" alt="zabbixat09" />
<img src="http://leon8693.github.io/images/blog_img/zabbixat10.png" alt="zabbixat10" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[zabbix 2.4.1 汉化界面和图 (二)]]></title>
    <link href="http://leon8693.github.io/blog/2014/10/17/zabbix-2-dot-4-1-yi-hua-jie-mian-he-tu-2/"/>
    <updated>2014-10-17T16:52:00+08:00</updated>
    <id>http://leon8693.github.io/blog/2014/10/17/zabbix-2-dot-4-1-yi-hua-jie-mian-he-tu-2</id>
    <content type="html"><![CDATA[<h2>界面修改中文</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>vim /mnt/www/zabbix/web/include/locales.inc.php 
</span><span class='line'>'zh_CN' =&gt; array('name' =&gt; _('Chinese (zh_CN)'),        'display' =&gt; false),
</span><span class='line'>修改成
</span><span class='line'>'zh_CN' =&gt; array('name' =&gt; _('Chinese (zh_CN)'),        'display' =&gt; true),</span></code></pre></td></tr></table></div></figure>


<h2>图画中文显示</h2>

<p>在没有处理的情况下,图片中的文字是乱码,如下 <br/>
<img src="http://leon8693.github.io/images/blog_img/zabbixcn01.png" alt="zabbixcn01" /></p>

<!-- more -->


<p>随后我们需要改变他,首先复制windows中的字库 <br/>
这个是我虚拟机中的XP字库,其他版本windows路径都一样如下<br/>
控制面板->字体->楷体(我复制的这个) <br/>
<img src="http://leon8693.github.io/images/blog_img/zabbixcn02.png" alt="zabbixcn02" /></p>

<p>复制出来的名字如图<br/>
<img src="http://leon8693.github.io/images/blog_img/zabbixcn03.png" alt="zabbixcn03" /></p>

<p>我们将他复制到下面这个目录,并且修改配置</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cp -rp simkai.ttf /mnt/www/zabbix/web/fonts/
</span><span class='line'>
</span><span class='line'>vim /mnt/www/zabbix/web/include/defines.inc.php
</span><span class='line'>//define('ZBX_GRAPH_FONT_NAME',         'DejaVuSans'); // font file name
</span><span class='line'>define('ZBX_GRAPH_FONT_NAME',           'simkai'); // font file name
</span><span class='line'>#保存退出
</span></code></pre></td></tr></table></div></figure>


<p>刷新页面查看<br/>
<img src="http://leon8693.github.io/images/blog_img/zabbixcn04.png" alt="zabbixcn04" /></p>

<p>OK,大功告成!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[zabbix 2.4.1 安装 （一）]]></title>
    <link href="http://leon8693.github.io/blog/2014/10/16/zabbix-2-dot-4-1-install-1/"/>
    <updated>2014-10-16T15:09:00+08:00</updated>
    <id>http://leon8693.github.io/blog/2014/10/16/zabbix-2-dot-4-1-install-1</id>
    <content type="html"><![CDATA[<h2>下载zabbix 2.4.1</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wget http://sourceforge.net/projects/zabbix/files/ZABBIX%20Latest%20Stable/2.4.1/zabbix-2.4.1.tar.gz/download -O zabbix-2.4.1.tar.gz
</span><span class='line'>yum install libc-client.x86_64 curl-devel.x86_64 openssl-devel.x86_64 libpng-devel.x86_64 libjpeg-devel.x86_64 mysql.x86_64 mysql-devel.x86_64 libc-client-devel bzip2-devel.x86_64 gmp-devel.x86_64 libmcrypt-devel.x86_64 libxslt-devel.x86_64 libtool-ltdl-devel.x86_64 freetype-devel freetype -y
</span><span class='line'>yum install php-leon -y    #这个包可以参考rpm制作篇</span></code></pre></td></tr></table></div></figure>


<h2>配置PHP</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#修改几个配置
</span><span class='line'>vim /usr/local/php-fpm/lib/php.ini
</span><span class='line'>max_execution_time = 300
</span><span class='line'>max_input_time=300
</span><span class='line'>date.timezone = Asia/Shanghai
</span><span class='line'>post_max_size = 32M
</span><span class='line'>memory_limit = 128M
</span><span class='line'>error_reporting = E_ALL & ~E_NOTICE
</span><span class='line'>short_open_tag = On
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>#修改php-fpm配置
</span><span class='line'>[global]
</span><span class='line'>pid = /usr/local/php-fpm/var/run/php-fpm.pid
</span><span class='line'>error_log = /mnt/data1/logs/php-fpm/php-fpm.log
</span><span class='line'>log_level = notice
</span><span class='line'>emergency_restart_threshold = 20
</span><span class='line'>emergency_restart_interval = 10m
</span><span class='line'>process_control_timeout = 10s
</span><span class='line'>events.mechanism = epoll
</span><span class='line'>[php-1]
</span><span class='line'>user = nobody
</span><span class='line'>group = nobody
</span><span class='line'>listen = /usr/local/php-fpm/php-fpm.sock
</span><span class='line'>listen.backlog = -1
</span><span class='line'>pm = dynamic
</span><span class='line'>pm.max_children = 80
</span><span class='line'>pm.start_servers = 10
</span><span class='line'>pm.min_spare_servers = 5
</span><span class='line'>pm.max_spare_servers = 20
</span><span class='line'>pm.max_requests = 500
</span><span class='line'>pm.status_path = /status
</span><span class='line'>access.log = /mnt/data1/logs/php-fpm/php-access.log
</span><span class='line'>access.format = %m - [%u %t] " "%n"   ""%r%Q%q""    "%s"   "%{mili}d"   "%{kilobytes}M" "%C%%
</span><span class='line'>slowlog = /mnt/data1/logs/php-fpm/php_slow.log
</span><span class='line'>request_slowlog_timeout = 1s
</span><span class='line'>request_terminate_timeout = 120s
</span><span class='line'>rlimit_files = 65535
</span><span class='line'>rlimit_core = unlimited
</span><span class='line'>catch_workers_output = yes
</span><span class='line'>env[HOSTNAME] = $HOSTNAME
</span><span class='line'>env[TMP] = /tmp
</span><span class='line'>env[TMPDIR] = /tmp
</span><span class='line'>env[TEMP] = /tmp
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>#php添加gettext模块,jpeg模块,FreeType模块
</span><span class='line'>yum install autoconf m4 -y
</span><span class='line'>cd php-5.3.10/ext/gettext/
</span><span class='line'>/usr/local/php-fpm/bin/phpize
</span><span class='line'>./configure && make && make install
</span><span class='line'>
</span><span class='line'>cd php-5.3.10/ext/gd/   #我打的php包中没有使用默认gd,这边可以方便一起添加jpeg和freetype,不然需要重新编译
</span><span class='line'>./configure --with-jpeg-dir=/usr/lib64/ --with-freetype-dir=/usr/lib64/
</span><span class='line'>make && make install 
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>#在php.ini配置文件中增加
</span><span class='line'>vim /usr/local/php-fpm/lib/php.ini
</span><span class='line'>[getext]
</span><span class='line'>extension=gettext.so
</span><span class='line'>[gd]
</span><span class='line'>extension=gd.so
</span><span class='line'>/usr/local/php-fpm/bin/php -m |grep "gettext" #存在说明完成
</span><span class='line'>/etc/init.d/php-fpm start</span></code></pre></td></tr></table></div></figure>


<!-- more -->


<h2>配置nginx</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>vim /etc/nginx/conf.d/zabbix.conf
</span><span class='line'>server {
</span><span class='line'>    listen 80;
</span><span class='line'>    server_name  _;
</span><span class='line'>    root  /var/www/html/;
</span><span class='line'>    error_log /mnt/data1/logs/nginx/localhost_error.log debug;
</span><span class='line'>    index index.php;
</span><span class='line'>        location  / {
</span><span class='line'>        root /var/www/html/;
</span><span class='line'>        index index.php index.html index.htm;
</span><span class='line'>  }
</span><span class='line'>        location ~ \.php$ {
</span><span class='line'>        include fastcgi_params;
</span><span class='line'>        fastcgi_pass unix:/usr/local/php-fpm/php-fpm.sock;
</span><span class='line'>        fastcgi_index index.php;
</span><span class='line'>        fastcgi_param SCRIPT_FILENAME  $document_root$fastcgi_script_name;
</span><span class='line'>        fastcgi_temp_path /tmp/temp;
</span><span class='line'>    }
</span><span class='line'>    access_log /mnt/data1/logs/nginx/localhost.log gzip;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>vim /var/www/html/index.php
</span><span class='line'>&lt;?php
</span><span class='line'>phpinfo();
</span><span class='line'>?&gt;
</span><span class='line'>
</span><span class='line'>/etc/init.d/nginx restart</span></code></pre></td></tr></table></div></figure>


<p>如出现下图说明nginx+php部署完成 <br/>
<img src="http://leon8693.github.io/images/blog_img/phpinfo.png" alt="phpinfo" /></p>

<h2>install zabbix</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#创建zabbix用户
</span><span class='line'>groupadd zabbix
</span><span class='line'>useradd -g zabbix -s /sbin/nologin zabbix
</span><span class='line'>
</span><span class='line'>yum install net-snmp net-snmp-devel -y
</span><span class='line'>cd zabbix-2.4.1
</span><span class='line'>./configure --prefix=/mnt/www/zabbix/ --enable-server --enable-agent --with-mysql=/usr/lib64/mysql/mysql_config --with-net-snmp  --with-curl
</span><span class='line'>make && make install
</span><span class='line'>
</span><span class='line'>#添加services中zabbix端口规划
</span><span class='line'>vim /etc/services
</span><span class='line'>zabbix-agent    10050/tcp               #Zabbix Agent
</span><span class='line'>zabbix-agent    10050/udp               #Zabbix Agent
</span><span class='line'>zabbix-trapper  10051/tcp               #Zabbix Trapper
</span><span class='line'>zabbix-trapper  10051/udp               #Zabbix Trapper
</span><span class='line'>
</span><span class='line'>#修改配置
</span><span class='line'>mkdir -p  /mnt/data1/logs/zabbix/
</span><span class='line'>mkdir -p /var/run/zabbix/
</span><span class='line'>mkdir -p /mnt/www/zabbix/web
</span><span class='line'>cp -rp /srv/zabbix-2.4.1/frontends/php/* /mnt/www/zabbix/web/
</span><span class='line'>chown zabbix.zabbix -R /mnt/www/zabbix/
</span><span class='line'>chown zabbix.zabbix /var/run/zabbix/
</span><span class='line'>chown zabbix.zabbix -R /mnt/data1/logs/zabbix/
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>vim /mnt/www/zabbix/etc/zabbix_server.conf
</span><span class='line'>LogFile=/mnt/data1/logs/zabbix/zabbix_server.log
</span><span class='line'>PidFile=/var/run/zabbix/zabbix.pid
</span><span class='line'>DBHost=192.168.0.210
</span><span class='line'>DBName=zabbix
</span><span class='line'>DBUser=zabbix
</span><span class='line'>DBPassword=zabbix
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>#增加zabbix库
</span><span class='line'>mysql -uroot -p
</span><span class='line'>mysql&gt; create database zabbix;
</span><span class='line'>mysql&gt; GRANT ALL PRIVILEGES ON zabbix.* TO zabbix@'192.168.0.%' IDENTIFIED BY 'zabbix';
</span><span class='line'>mysql&gt; flush privileges;
</span><span class='line'>
</span><span class='line'>#将安装包里的库文件导入到zabbix库
</span><span class='line'>mysql -uroot -p zabbix -h192.168.0.210 &lt; /srv/zabbix-2.4.1/database/mysql/schema.sql
</span><span class='line'>mysql -uroot -p zabbix -h192.168.0.210 &lt; /srv/zabbix-2.4.1/database/mysql/images.sql
</span><span class='line'>mysql -uroot -p zabbix -h192.168.0.210 &lt; /srv/zabbix-2.4.1/database/mysql/data.sql
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>#复制修改zabbix启动脚本
</span><span class='line'>\cp -rp /srv/zabbix-2.4.1/misc/init.d/tru64/zabbix_* /etc/init.d/
</span><span class='line'>chmod +x /etc/init.d/zabbix*
</span><span class='line'>sed -i "s/DAEMON=.*/DAEMON=\/mnt\/www\/zabbix\/sbin\/zabbix_server/g" /etc/init.d/zabbix_server
</span><span class='line'>sed -i "s/PIDFILE=.*/PIDFILE=\/var\/run\/zabbix\/zabbix.pid/g" /etc/init.d/zabbix_server
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>#启动server
</span><span class='line'>/etc/init.d/zabbix_server start</span></code></pre></td></tr></table></div></figure>


<h2>web配置</h2>

<p>查看需要的依赖是否解决 <br/>
<a href="http://192.168.0.212/">http://192.168.0.212/</a> <br/>
<img src="http://leon8693.github.io/images/blog_img/zabbix01.png" alt="zabbix01" /></p>

<p>设置zabbix数据库配置 <br/>
<img src="http://leon8693.github.io/images/blog_img/zabbix02.png" alt="zabbix02" /></p>

<p>设置web配置 <br/>
<img src="http://leon8693.github.io/images/blog_img/zabbix03.png" alt="zabbix03" /></p>

<p>如果设置出现问题也可以通过配置文件直接修改如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nx">cp</span> <span class="o">-</span><span class="nx">rp</span>  <span class="o">/</span><span class="nx">mnt</span><span class="o">/</span><span class="nx">www</span><span class="o">/</span><span class="nx">zabbix</span><span class="o">/</span><span class="nx">web</span><span class="o">/</span><span class="nx">conf</span><span class="o">/</span><span class="nx">zabbix</span><span class="o">.</span><span class="nx">conf</span><span class="o">.</span><span class="nx">php</span><span class="o">.</span><span class="nx">example</span> <span class="o">/</span><span class="nx">mnt</span><span class="o">/</span><span class="nx">www</span><span class="o">/</span><span class="nx">zabbix</span><span class="o">/</span><span class="nx">web</span><span class="o">/</span><span class="nx">conf</span><span class="o">/</span><span class="nx">zabbix</span><span class="o">.</span><span class="nx">conf</span><span class="o">.</span><span class="nx">php</span>
</span><span class='line'><span class="nx">vim</span> <span class="o">/</span><span class="nx">mnt</span><span class="o">/</span><span class="nx">www</span><span class="o">/</span><span class="nx">zabbix</span><span class="o">/</span><span class="nx">web</span><span class="o">/</span><span class="nx">conf</span><span class="o">/</span><span class="nx">zabbix</span><span class="o">.</span><span class="nx">conf</span><span class="o">.</span><span class="nx">php</span>
</span><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'><span class="c1">// Zabbix GUI configuration file</span>
</span><span class='line'><span class="k">global</span> <span class="nv">$DB</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$DB</span><span class="p">[</span><span class="s2">&quot;TYPE&quot;</span><span class="p">]</span>                     <span class="o">=</span> <span class="s1">&#39;MYSQL&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nv">$DB</span><span class="p">[</span><span class="s2">&quot;SERVER&quot;</span><span class="p">]</span>                   <span class="o">=</span> <span class="s1">&#39;192.168.0.210&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nv">$DB</span><span class="p">[</span><span class="s2">&quot;PORT&quot;</span><span class="p">]</span>                     <span class="o">=</span> <span class="s1">&#39;3306&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nv">$DB</span><span class="p">[</span><span class="s2">&quot;DATABASE&quot;</span><span class="p">]</span>                 <span class="o">=</span> <span class="s1">&#39;zabbix&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nv">$DB</span><span class="p">[</span><span class="s2">&quot;USER&quot;</span><span class="p">]</span>                     <span class="o">=</span> <span class="s1">&#39;zabbix&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nv">$DB</span><span class="p">[</span><span class="s2">&quot;PASSWORD&quot;</span><span class="p">]</span>                 <span class="o">=</span> <span class="s1">&#39;zabbix&#39;</span><span class="p">;</span>
</span><span class='line'><span class="c1">// SCHEMA is relevant only for IBM_DB2 database</span>
</span><span class='line'><span class="nv">$DB</span><span class="p">[</span><span class="s2">&quot;SCHEMA&quot;</span><span class="p">]</span>                   <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$ZBX_SERVER</span>                     <span class="o">=</span> <span class="s1">&#39;192.168.0.212&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nv">$ZBX_SERVER_PORT</span>                <span class="o">=</span> <span class="s1">&#39;10051&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nv">$ZBX_SERVER_NAME</span>                <span class="o">=</span> <span class="s1">&#39;zabbix&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$IMAGE_FORMAT_DEFAULT</span>   <span class="o">=</span> <span class="nx">IMAGE_FORMAT_PNG</span><span class="p">;</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>可以访问后输入默认用户名密码进入,就大功告成了<br/>
username: Admin<br/>
password: zabbix</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[yum 私有源]]></title>
    <link href="http://leon8693.github.io/blog/2014/10/15/yum-si-you-yuan/"/>
    <updated>2014-10-15T16:17:00+08:00</updated>
    <id>http://leon8693.github.io/blog/2014/10/15/yum-si-you-yuan</id>
    <content type="html"><![CDATA[<h2>yum私有源</h2>

<p>当自己制作RPM包后发现还需要一个私有的yum源 <br/>
下面就自己搭建一个</p>

<!-- more -->


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#安装需要的包
</span><span class='line'>yum -y install createrepo 
</span><span class='line'>
</span><span class='line'>#创建需要存放RPM包的目录
</span><span class='line'>mkdir -p /mnt/rpm/centos6
</span><span class='line'>
</span><span class='line'>#放入自定义的包
</span><span class='line'>cp -rp php-leon-5.3.10-0.x86_64.rpm /mnt/rpm/centos6/
</span><span class='line'>
</span><span class='line'>#创建yum使用的createrepo索引
</span><span class='line'>createrepo /mnt/rpm/centos6/
</span><span class='line'>
</span><span class='line'>#这里使用nginx中的http模式,所以编辑nginx
</span><span class='line'>vim /etc/nginx/conf.d/yum.conf
</span><span class='line'>server  {
</span><span class='line'>        listen 80;
</span><span class='line'>        server_name yum.leon.com;
</span><span class='line'>        index  idex.html;
</span><span class='line'>        autoindex on;
</span><span class='line'>        root /mnt/rpm/;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>/etc/init.d/nginx reload
</span><span class='line'>
</span><span class='line'>#增加repo
</span><span class='line'>vim /etc/yum.repos.d/leon.repo
</span><span class='line'>[leon-centos6]
</span><span class='line'>name=Extra Packages for Enterprise Linux 6 - $basearch
</span><span class='line'>baseurl=http://yum.leon.com/rpm/
</span><span class='line'>enabled=1
</span><span class='line'>gpgcheck=0
</span><span class='line'>keepcache=1
</span><span class='line'>gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6
</span><span class='line'>
</span><span class='line'>#yum makecache内容
</span><span class='line'>yum makecache
</span><span class='line'>
</span><span class='line'>yum install php-leon -y</span></code></pre></td></tr></table></div></figure>


<p>大功告成！</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rpmbuild 打包rpm实战]]></title>
    <link href="http://leon8693.github.io/blog/2014/10/14/rpmbuild-da-bao-rpmshi-zhan/"/>
    <updated>2014-10-14T15:49:00+08:00</updated>
    <id>http://leon8693.github.io/blog/2014/10/14/rpmbuild-da-bao-rpmshi-zhan</id>
    <content type="html"><![CDATA[<h2>基本信息</h2>

<p>CentOS release 6.4 (Final) <br/>
2.6.32-358.el6.x86_64</p>

<h2>rpmbuild目录设置</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#自定义编译的目录</span>
</span><span class='line'>vim ~/.rpmmacros
</span><span class='line'>%_topdir /root/rpmbuild
</span><span class='line'>%_tmppath /root/rpmbuild/tmp
</span><span class='line'>%buildroot /root/rpmbuild/BUILDROOT
</span><span class='line'>%_prefix  /
</span><span class='line'>
</span><span class='line'><span class="c">#创建自定义目录</span>
</span><span class='line'>mkdir -p ~/rpmbuild/<span class="o">{</span>BUILD,RPMS,SOURCES,SPECS,SRPMS<span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c">#存放目录状态</span>
</span><span class='line'><span class="o">[</span>root@angel02 rpmbuild<span class="o">]</span><span class="c"># tree</span>
</span><span class='line'>.
</span><span class='line'>├── BUILD
</span><span class='line'>├── RPMS
</span><span class='line'>├── SOURCES
</span><span class='line'>│   └── php-5.3.10.tar.gz
</span><span class='line'>├── SPECS
</span><span class='line'>│   └── php5.spec
</span><span class='line'>├── SRPMS
</span><span class='line'>└── tmp
</span><span class='line'>
</span><span class='line'>vim /usr/lib/rpm/macros
</span><span class='line'>%_topdir                %<span class="o">{</span>getenv:HOME<span class="o">}</span>/rpmbuild <span class="c">#注释掉</span>
</span><span class='line'>%_topdir                %<span class="o">{</span>_usrsrc<span class="o">}</span>/
</span></code></pre></td></tr></table></div></figure>




<!-- more -->


<h2>编辑spec</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>%define version 5.3.10
</span><span class='line'>%define so_version 5
</span><span class='line'>%define release 0
</span><span class='line'>
</span><span class='line'>Name: php-fdm
</span><span class='line'>Summary: PHP: Hypertext Preprocessor
</span><span class='line'>Group: Development/Languages
</span><span class='line'>Version: %<span class="o">{</span>version<span class="o">}</span>
</span><span class='line'>Release: %<span class="o">{</span>release<span class="o">}</span>
</span><span class='line'>Source: php-5.3.10.tar.gz
</span><span class='line'>URL: http://www.php.net/
</span><span class='line'>Packager: bolatuleon@hotmail.com
</span><span class='line'>License: GPL
</span><span class='line'>BuildRoot: /var/tmp/php-%<span class="o">{</span>version<span class="o">}</span>
</span><span class='line'>
</span><span class='line'>%description
</span><span class='line'>Leon php5 package
</span><span class='line'>
</span><span class='line'>%prep
</span><span class='line'>%setup -q
</span><span class='line'>./configure  --prefix<span class="o">=</span>/usr/local/php-fpm --with-libdir<span class="o">=</span>lib64 --enable-cgi --enable-fpm --with-imap<span class="o">=</span>/usr --with-imap-ssl --enable-bcmath --with-kerberos --with-bz2 --enable-calendar --enable-ctype --with-curl --enable-dom --enable-exif --enable-fileinfo --enable-filter --enable-ftp --with-gd --with-gmp --enable-hash --with-iconv --enable-json --enable-libxml --enable-mbstring --with-mcrypt --with-mysql --with-mysqli --with-openssl --enable-pcntl --enable-PDO --with-pdo_mysql --with-pdo_sqlite --enable-Phar --enable-posix --enable-session --enable-shmop --enable-SimpleXML --enable-sockets --with-sqlite3 --enable-sysvmsg --enable-sysvsem --enable-tokenizer --enable-wddx --enable-xml --enable-xmlreader --enable-xmlwriter --with-xsl --enable-zip --with-zlib
</span><span class='line'>
</span><span class='line'>make
</span><span class='line'>
</span><span class='line'>%install
</span><span class='line'><span class="c">#make DESTDIR=$RPM_BUILD_ROOT install</span>
</span><span class='line'><span class="c">#DESTDIR是Makefile文件中定义的一个安装路径的变量，根据实际情况修改，比如mysql和nginx的是DESTDIR，而php的是INSTALL_ROOT。</span>
</span><span class='line'>make <span class="nv">INSTALL_ROOT</span><span class="o">=</span><span class="nv">$RPM_BUILD_ROOT</span> install
</span><span class='line'>mkdir -p <span class="nv">$RPM_BUILD_ROOT</span>/usr/local/php-fpm/init/
</span><span class='line'>cp -rp <span class="nv">$RPM_BUILD_DIR</span>/php-fdm-5.3.10/sapi/fpm/init.d.php-fpm <span class="nv">$RPM_BUILD_ROOT</span>/usr/local/php-fpm/init/php-fpm
</span><span class='line'>cp -rp <span class="nv">$RPM_BUILD_DIR</span>/php-fdm-5.3.10/php.ini-production <span class="nv">$RPM_BUILD_ROOT</span>/usr/local/php-fpm/lib/php.ini
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>%clean
</span><span class='line'><span class="o">[</span> <span class="s2">&quot;$RPM_BUILD_ROOT&quot;</span> !<span class="o">=</span> <span class="s2">&quot;/&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> rm -rf <span class="s2">&quot;$RPM_BUILD_ROOT&quot;</span>
</span><span class='line'>make clean
</span><span class='line'>
</span><span class='line'>%post
</span><span class='line'>ln -s /usr/local/php-fpm/bin/* /usr/local/bin/
</span><span class='line'>mkdir -p /mnt/data1/logs/php-fpm/
</span><span class='line'>cat <span class="s">&lt;&lt; EOF &gt; /etc/logrotate.d/php-fpm</span>
</span><span class='line'><span class="s">/mnt/data1/logs/php-fpm/*.log {</span>
</span><span class='line'><span class="s">        daily</span>
</span><span class='line'><span class="s">        missingok</span>
</span><span class='line'><span class="s">        rotate 7</span>
</span><span class='line'><span class="s">        compress</span>
</span><span class='line'><span class="s">        notifempty</span>
</span><span class='line'><span class="s">        sharedscripts</span>
</span><span class='line'><span class="s">        dateext</span>
</span><span class='line'><span class="s">        postrotate</span>
</span><span class='line'><span class="s">                [ -f /var/run/php-fpm.pid ] &amp;&amp; kill -USR1 \`cat /var/run/php-fpm.pid\`</span>
</span><span class='line'><span class="s">        endscript</span>
</span><span class='line'><span class="s">}</span>
</span><span class='line'><span class="s">EOF</span>
</span><span class='line'>
</span><span class='line'>cp -rp /usr/local/php-fpm/init/php-fpm /etc/init.d/php-fpm
</span><span class='line'>chmod +x /etc/init.d/php-fpm
</span><span class='line'>sed -i <span class="s2">&quot;s/php_opts=\&quot;--fpm-config \$php_fpm_CONF\&quot;/php_opts=\&quot;--fpm-config \$php_fpm_CONF -g \$php_fpm_PID\&quot;/g&quot;</span> /etc/init.d/php-fpm
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>%postun
</span><span class='line'>rm -rf /usr/local/bin/pear /usr/local/bin/peardev /usr/local/bin/pecl /usr/local/bin/phar /usr/local/bin/phar.phar /usr/local/bin/php /usr/local/bin/php-config /usr/local/bin/phpize
</span><span class='line'>rm -rf /etc/logrotate.d/php-fpm
</span><span class='line'>rm -rf /etc/init.d/php-fpm
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>%files
</span><span class='line'>%defattr <span class="o">(</span>-,root,root<span class="o">)</span>
</span><span class='line'>/usr/local/php-fpm/
</span><span class='line'>/usr/local/php-fpm/init/php-fpm
</span><span class='line'>/usr/local/php-fpm/lib/php.ini
</span><span class='line'>/.channels/.alias/pear.txt
</span><span class='line'>/.channels/.alias/pecl.txt
</span><span class='line'>/.channels/.alias/phpdocs.txt
</span><span class='line'>/.channels/__uri.reg
</span><span class='line'>/.channels/doc.php.net.reg
</span><span class='line'>/.channels/pear.php.net.reg
</span><span class='line'>/.channels/pecl.php.net.reg
</span><span class='line'>/.depdb
</span><span class='line'>/.depdblock
</span><span class='line'>/.filemap
</span><span class='line'>/.lock
</span></code></pre></td></tr></table></div></figure>


<h2>开始制作包</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#安装需要的依赖包</span>
</span><span class='line'>yum install libc-client.x86_64 curl-devel openssl-devel.x86_64 libpng-devel.x86_64 libjpeg-devel mysql.x86_64 mysql-devel.x86_64 libc-client-devel bzip2-devel.x86_64 gmp-devel.x86_64 libmcrypt-devel.x86_64 libxslt-devel.x86_64 libtool-ltdl-devel.x86_64 -y
</span><span class='line'>
</span><span class='line'><span class="c">#制作src和rpm包</span>
</span><span class='line'>rpmbuild -ba ~/rpmbuild/SPECS/php5.spec
</span><span class='line'>
</span><span class='line'><span class="c">#经过一连串的编译过程之后如下</span>
</span><span class='line'><span class="o">[</span>root@angel02 php-fpm<span class="o">]</span><span class="c"># ls /root/rpmbuild/RPMS/x86_64/</span>
</span><span class='line'>php-fdm-5.3.10-0.x86_64.rpm
</span><span class='line'><span class="o">[</span>root@angel02 php-fpm<span class="o">]</span><span class="c"># ls /root/rpmbuild/SRPMS/</span>
</span><span class='line'>php-fdm-5.3.10-0.src.rpm
</span><span class='line'>
</span><span class='line'><span class="c">#分别获得了这2个包,安装一下rpm包是否有问题,自行调试</span>
</span></code></pre></td></tr></table></div></figure>


<h2>问题合集</h2>

<p>1.error: Installed (but unpackaged) file(s) found:  <br/>
解决如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>在%file中将文件全部加入
</span><span class='line'>%files
</span><span class='line'>%defattr <span class="o">(</span>-,root,root<span class="o">)</span>
</span><span class='line'>/usr/local/php/
</span><span class='line'>/.channels/.alias/pear.txt
</span><span class='line'>/.channels/.alias/pecl.txt
</span><span class='line'>/.channels/.alias/phpdocs.txt
</span><span class='line'>/.channels/__uri.reg
</span><span class='line'>/.channels/doc.php.net.reg
</span><span class='line'>/.channels/pear.php.net.reg
</span><span class='line'>/.channels/pecl.php.net.reg
</span><span class='line'>/.depdb
</span><span class='line'>/.depdblock
</span><span class='line'>/.filemap
</span><span class='line'>/.lock
</span><span class='line'>或者
</span><span class='line'>进入文件/usr/lib/rpm/macros,找到
</span><span class='line'>%__check_files         %<span class="o">{</span>_rpmconfigdir<span class="o">}</span>/check-files %<span class="o">{</span>buildroot<span class="o">}</span>
</span><span class='line'>这一行，把这一行注释掉，然后重新编译
</span></code></pre></td></tr></table></div></figure>


<p>2.error: License field must be present in package: (main package) <br/>
解决如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vim php5.spec
</span><span class='line'>添加
</span><span class='line'>License: GPL <span class="c">#一般都是GPL这个自行判断</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[saltstack 自动化配置管理实战 (五)]]></title>
    <link href="http://leon8693.github.io/blog/2014/10/10/saltstack-zi-dong-hua-pei-zhi-guan-li-shi-zhan-05/"/>
    <updated>2014-10-10T10:17:00+08:00</updated>
    <id>http://leon8693.github.io/blog/2014/10/10/saltstack-zi-dong-hua-pei-zhi-guan-li-shi-zhan-05</id>
    <content type="html"><![CDATA[<h2>自动化部署配置文件</h2>

<h4>/etc/resolv.conf</h4>

<p>对所有/etc/resolv.conf进行部署,指定nameserver和search  <br/>
angel01是DNS SERVER,angel02是客户端,我们做一个让angel01的resolv.conf中nameserver为127.0.0.1,其他nameserver ip是192.168.0.210</p>

<!-- more -->


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#首先设置pillar需要区分的数据
</span><span class='line'>vim /mnt/config/salt/pillar/top.sls
</span><span class='line'>base:
</span><span class='line'>  '*':
</span><span class='line'>   - base.resolv
</span><span class='line'>mkdir /mnt/config/salt/pillar/base/
</span><span class='line'>vim /mnt/config/salt/pillar/base/resolv.sls
</span><span class='line'>
</span><span class='line'>nameserver: ['192.168.0.210','202.96.209.133']
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>vim /mnt/config/salt/top.sls
</span><span class='line'>base:
</span><span class='line'>  '*':
</span><span class='line'>  - base.resolv
</span><span class='line'>mkdir -p /mnt/config/salt/base/
</span><span class='line'>vim /mnt/config/salt/base/resolv.sls
</span><span class='line'>/etc/resolv.conf:                                   #文件路径
</span><span class='line'>  file.managed:                                     #sls函数,修改添加文件
</span><span class='line'>  - source:  salt://base/jinja/resolv.conf.jinja    #jinja的文件位置
</span><span class='line'>  - user: root                                      #用户属性
</span><span class='line'>  - group: root                                     #用户组属性
</span><span class='line'>  - mode: 644                                       #用户权限
</span><span class='line'>  - backup: minion                                  #minion客户端本地备份/var/cach/salt/
</span><span class='line'>  - template: jinja                                 #使用jinja模板
</span><span class='line'>
</span><span class='line'>vim /mnt/config/salt/base/jinja/resolv.conf.jinja
</span><span class='line'>search i.fdmdns.com
</span><span class='line'>nameserver 
</span><span class='line'>nameserver 
</span><span class='line'>
</span><span class='line'>#使用命令测试
</span><span class='line'>[root@angel01 salt]# salt '*' pillar.item nameserver
</span><span class='line'>angel01.i.fdmdns.com:
</span><span class='line'>    ----------
</span><span class='line'>    nameserver:
</span><span class='line'>        - 127.0.0.1
</span><span class='line'>        - 202.96.209.133
</span><span class='line'>angel02.i.fdmdns.com:
</span><span class='line'>    ----------
</span><span class='line'>    nameserver:
</span><span class='line'>        - 192.168.0.210
</span><span class='line'>        - 202.96.209.133
</span><span class='line'>#pillar已经有我们属性了,然后同步写入文件内容
</span><span class='line'>[root@angel01 salt]# salt '*' state.highstate -v
</span><span class='line'>Executing job with jid 20141010150603492444
</span><span class='line'>-------------------------------------------
</span><span class='line'>
</span><span class='line'>angel01.i.fdmdns.com:
</span><span class='line'>----------
</span><span class='line'>          ID: /etc/resolv.conf
</span><span class='line'>    Function: file.managed
</span><span class='line'>      Result: True
</span><span class='line'>     Comment: File /etc/resolv.conf updated
</span><span class='line'>     Changes:   
</span><span class='line'>              ----------
</span><span class='line'>              diff:
</span><span class='line'>                  New file
</span><span class='line'>              mode:
</span><span class='line'>                  0644
</span><span class='line'>
</span><span class='line'>Summary
</span><span class='line'>------------
</span><span class='line'>Succeeded: 1
</span><span class='line'>Failed:    0
</span><span class='line'>------------
</span><span class='line'>Total:     1
</span><span class='line'>angel02.i.fdmdns.com:
</span><span class='line'>----------
</span><span class='line'>          ID: /etc/resolv.conf
</span><span class='line'>    Function: file.managed
</span><span class='line'>      Result: True
</span><span class='line'>     Comment: File /etc/resolv.conf updated
</span><span class='line'>     Changes:   
</span><span class='line'>              ----------
</span><span class='line'>              diff:
</span><span class='line'>                  New file
</span><span class='line'>              mode:
</span><span class='line'>                  0644
</span><span class='line'>
</span><span class='line'>Summary
</span><span class='line'>------------
</span><span class='line'>Succeeded: 1
</span><span class='line'>Failed:    0
</span><span class='line'>------------
</span><span class='line'>Total:     1
</span><span class='line'>#查看文件，如果符合则完成</span></code></pre></td></tr></table></div></figure>


<p>未完待续。。。。。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[saltstack grains,pillar,sls模板,jinja模板 (四)]]></title>
    <link href="http://leon8693.github.io/blog/2014/09/30/saltstack-grains-pillar-slsmo-ban-jinjamo-ban-4/"/>
    <updated>2014-09-30T16:16:00+08:00</updated>
    <id>http://leon8693.github.io/blog/2014/09/30/saltstack-grains-pillar-slsmo-ban-jinjamo-ban-4</id>
    <content type="html"><![CDATA[<h2>grains</h2>

<p>grains类似puppet的facter一样 负责采集客户端一些基本信息,也可以自定义</p>

<h4>grains使用</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>salt -E 'angel01' grains.ls   #查看有多少定义好的属性可以用
</span><span class='line'>salt -E 'angel01' grains.items #查看所有属性返回的值
</span><span class='line'>salt -E 'angel01' grains.item fqdn os #查看fqdn os 返回的值,以此类推</span></code></pre></td></tr></table></div></figure>


<h4>grains自定义</h4>

<h5>服务端主动推送</h5>

<p>master上操作</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>vim /mnt/config/salt/master
</span><span class='line'>增加默认目录
</span><span class='line'>file_roots:
</span><span class='line'>  base:
</span><span class='line'>      - /mnt/config/salt/
</span><span class='line'>
</span><span class='line'>mkdir -p /mnt/config/salt/_grains/
</span><span class='line'>vim /mnt/config/salt/_grains/test.py
</span><span class='line'># -*- coding: utf-8 -*-
</span><span class='line'>
</span><span class='line'>'''
</span><span class='line'>leon test
</span><span class='line'>'''
</span><span class='line'>import commands
</span><span class='line'>import os
</span><span class='line'>
</span><span class='line'>def l_test():
</span><span class='line'>    '''
</span><span class='line'>    leon test
</span><span class='line'>    '''
</span><span class='line'>    grains={}
</span><span class='line'>    a = commands.getoutput("hostname")
</span><span class='line'>    grains['leon_test']=a
</span><span class='line'>
</span><span class='line'>    return grains</span></code></pre></td></tr></table></div></figure>


<p>使用命令<code>saltutil.sync_all</code>进行推送</p>

<!-- more -->


<p>再通过salt &lsquo;*&rsquo; grains.item leon_test就可以查看了</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@angel01 salt]# salt '*' saltutil.sync_all
</span><span class='line'>angel01.i.fdmdns.com:
</span><span class='line'>    ----------
</span><span class='line'>    grains:
</span><span class='line'>        - grains.test
</span><span class='line'>    modules:
</span><span class='line'>    outputters:
</span><span class='line'>    renderers:
</span><span class='line'>    returners:
</span><span class='line'>    states:
</span><span class='line'>angel02.i.fdmdns.com:
</span><span class='line'>    ----------
</span><span class='line'>    grains:
</span><span class='line'>        - grains.test
</span><span class='line'>    modules:
</span><span class='line'>    outputters:
</span><span class='line'>    renderers:
</span><span class='line'>    returners:
</span><span class='line'>    states:
</span><span class='line'>
</span><span class='line'>[root@angel01 salt]# salt '*' grains.item leon_test
</span><span class='line'>angel01.i.fdmdns.com:
</span><span class='line'>  leon_test: angel01
</span><span class='line'>angel02.i.fdmdns.com:
</span><span class='line'>  leon_test: angel02</span></code></pre></td></tr></table></div></figure>


<p>模块进行更改后需要使用<code>sys.reload_modules</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@angel01 salt]# salt '*' sys.reload_modules
</span><span class='line'>angel01.i.fdmdns.com:
</span><span class='line'>    True
</span><span class='line'>angel02.i.fdmdns.com:
</span><span class='line'>    True
</span><span class='line'>[root@angel01 salt]# salt '*' saltutil.sync_all 
</span><span class='line'>angel01.i.fdmdns.com:
</span><span class='line'>    ----------
</span><span class='line'>    grains:
</span><span class='line'>        - grains.test
</span><span class='line'>    modules:
</span><span class='line'>    outputters:
</span><span class='line'>    renderers:
</span><span class='line'>    returners:
</span><span class='line'>    states:
</span><span class='line'>angel02.i.fdmdns.com:
</span><span class='line'>    ----------
</span><span class='line'>    grains:
</span><span class='line'>        - grains.test
</span><span class='line'>    modules:
</span><span class='line'>    outputters:
</span><span class='line'>    renderers:
</span><span class='line'>    returners:
</span><span class='line'>    states:
</span><span class='line'>[root@angel01 salt]# salt '*' grains.item leon_test
</span><span class='line'>angel01.i.fdmdns.com:
</span><span class='line'>  leon_test: this is test
</span><span class='line'>angel02.i.fdmdns.com:
</span><span class='line'>  leon_test: this is test</span></code></pre></td></tr></table></div></figure>


<h4>客户端自动汇报</h4>

<p>minion上操作</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>vim /etc/salt/minion
</span><span class='line'>default_include: /mnt/config/salt/minion.d/*.conf #增加这项
</span><span class='line'>mkdir -p /mnt/config/salt/minion.d/
</span><span class='line'>vim /mnt/config/salt/minion.d/test.conf
</span><span class='line'>grains:
</span><span class='line'>  leon and leon: 1
</span><span class='line'>  leon and alex: print 2
</span><span class='line'>  cpis:
</span><span class='line'>    - a
</span><span class='line'>    - b
</span><span class='line'>  leon.com:
</span><span class='line'>    -------------------------------------------------
</span><span class='line'>
</span><span class='line'>/etc/init.d/salt-minion restart
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>[root@angel01 ~]# salt -E 'angel01' grains.item leon\ and\ leon
</span><span class='line'>angel01.i.fdmdns.com:
</span><span class='line'>  leon and leon: 1
</span><span class='line'>[root@angel01 ~]# salt -E 'angel01' grains.item leon.com
</span><span class='line'>angel01.i.fdmdns.com:
</span><span class='line'>  leon.com: -------------------------------------------------
</span><span class='line'>[root@angel01 ~]# salt -E 'angel01' grains.item cpis
</span><span class='line'>angel01.i.fdmdns.com:
</span><span class='line'>  cpis:
</span><span class='line'>      a
</span><span class='line'>      b
</span></code></pre></td></tr></table></div></figure>


<h4>pillar使用</h4>

<p>pillar是用于给特定的minion定义任何你需要的数据,数据可以被salt其他组件使用,Pillar 数据是与特定 minion 关联的，也就是说每一个minion 都只能看到自己的数据， 所以 Pillar 可以用来传递敏感数据。  <br/>
pillar可以通过变量的方式再不同的操作系统或者特定的服务server上进行特别的设置。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#首先定义pillar的位置
</span><span class='line'>vim /mnt/config/salt/master
</span><span class='line'>interface: 192.168.0.210
</span><span class='line'>user: root
</span><span class='line'>auto_accept: True
</span><span class='line'>worker_threads: 5
</span><span class='line'>file_roots:
</span><span class='line'>  base:
</span><span class='line'>    - /mnt/config/salt/
</span><span class='line'>pillar_roots:                   #标识pillar目录
</span><span class='line'>  base:
</span><span class='line'>    - /mnt/config/salt/pillar</span></code></pre></td></tr></table></div></figure>


<p>在pilla目录中新建一个top.sls,类似Puppet的入口文件</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>vim /mnt/config/salt/pillar/top.sls
</span><span class='line'>base:       #自定义名称
</span><span class='line'>  '*':      #客户端过滤,可以是angel0[1-2].*,等等
</span><span class='line'>   - test   #模板名称
</span><span class='line'>
</span><span class='line'>vim /mnt/config/salt/pillar/test.sls
</span><span class='line'>MY_NAME: leon
</span><span class='line'>ID: 7758258
</span><span class='line'>CONTENT:  lol
</span><span class='line'>
</span><span class='line'>/etc/init.d/salt-master restart
</span><span class='line'>/etc/init.d/salt-minion restart
</span><span class='line'>
</span><span class='line'>[root@angel01 pillar]# salt  'angel01.i.fdmdns.com' pillar.data
</span><span class='line'>angel01.i.fdmdns.com:
</span><span class='line'>    ----------
</span><span class='line'>    CONTENT:
</span><span class='line'>        lol
</span><span class='line'>    ID:
</span><span class='line'>        7758258
</span><span class='line'>    MY_NAME:
</span><span class='line'>        leon
</span><span class='line'>    #这边有master默认的一些信息省略了</span></code></pre></td></tr></table></div></figure>


<p>下面结合state.sls和jinja做一个写文件的动作</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vim /mnt/config/salt/top.sls
</span><span class='line'>base:
</span><span class='line'>  <span class="s1">&#39;*&#39;</span>:
</span><span class='line'>   - test.tmp
</span><span class='line'>mkdir -p /mnt/config/salt/test/
</span><span class='line'>vim /mnt/config/salt/test/tmp.sls
</span><span class='line'>/tmp/tmp.conf:                              <span class="c">#文件位置</span>
</span><span class='line'>  file.managed:                             <span class="c">#采用新增文件的方式</span>
</span><span class='line'>  - <span class="nb">source</span>:  salt://test/tmp.conf.jinja     <span class="c">#jinja资源位置</span>
</span><span class='line'>  - template: jinja                         <span class="c">#模板</span>
</span><span class='line'>
</span><span class='line'>vim /mnt/config/salt/test/tmp.conf.jinja
</span><span class='line'>visible hostname  <span class="se">\{</span><span class="o">{</span> grains<span class="o">[</span><span class="s1">&#39;fqdn&#39;</span><span class="o">]</span> <span class="o">}}</span>      <span class="c">#通过grains获得的fqdn(hostname)</span>
</span><span class='line'><span class="se">\{</span><span class="o">{</span> pillar<span class="o">[</span><span class="s1">&#39;MY_NAME&#39;</span><span class="o">]</span> <span class="o">}}</span>                     <span class="c">#前面我用pillar定义的MY_NAME</span>
</span><span class='line'><span class="se">\{</span><span class="o">{</span> pillar<span class="o">[</span><span class="s1">&#39;ID&#39;</span><span class="o">]</span> <span class="o">}}</span>                          <span class="c">#注释的\号自己去掉,双括号情况下在makedown不显示= =！</span>
</span><span class='line'>server_os <span class="se">\{</span><span class="o">{</span> grains<span class="o">[</span><span class="s1">&#39;os&#39;</span><span class="o">]</span> <span class="o">}}</span>
</span><span class='line'>
</span><span class='line'>1.salt  <span class="s1">&#39;*&#39;</span> state.highstate -v              <span class="c">#方式1</span>
</span><span class='line'>2.salt  <span class="s1">&#39;angel01.i.fdmdns.com&#39;</span> state.sls test.tmp  <span class="c">#方式2</span>
</span><span class='line'>angel01.i.fdmdns.com:
</span><span class='line'>----------
</span><span class='line'>          ID: /tmp/tmp.conf
</span><span class='line'>    Function: file.managed
</span><span class='line'>      Result: True
</span><span class='line'>     Comment: File /tmp/tmp.conf updated
</span><span class='line'>     Changes:
</span><span class='line'>              ----------
</span><span class='line'>              diff:
</span><span class='line'>                  New file
</span><span class='line'>              mode:
</span><span class='line'>                  0644
</span><span class='line'>
</span><span class='line'>Summary
</span><span class='line'>------------
</span><span class='line'>Succeeded: 1
</span><span class='line'>Failed:    0
</span><span class='line'>------------
</span><span class='line'>Total:     1
</span><span class='line'><span class="c">#表示完成</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span>root@angel01 salt<span class="o">]</span><span class="c"># cat /tmp/tmp.conf </span>
</span><span class='line'>visible hostname  angel01
</span><span class='line'>leon
</span><span class='line'>7758258
</span><span class='line'>server_os CentOS
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[saltstack minion,nodegroup,cmd.run (三) ]]></title>
    <link href="http://leon8693.github.io/blog/2014/09/30/saltstack-minion-nodegroup-cmd-dot-run-3/"/>
    <updated>2014-09-30T10:31:00+08:00</updated>
    <id>http://leon8693.github.io/blog/2014/09/30/saltstack-minion-nodegroup-cmd-dot-run-3</id>
    <content type="html"><![CDATA[<h2>minion</h2>

<p>客户端标识默认采用主机名,也可以修改配置中的id来指定minion的名字    <br/>
vim /mnt/config/salt/minion</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>master: angel01.i.fdmdns.com
</span><span class='line'>user: root
</span><span class='line'>id: angel01.i.fdmdns.com #指定了这个客户端的名字</span></code></pre></td></tr></table></div></figure>


<p>查看minion状态,并且可以使用正则 <br/>
PS:必须在MASTER上操作</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@angel01 ~]# salt  'angel01.i.fdmdns.com'  test.ping
</span><span class='line'>angel01.i.fdmdns.com:
</span><span class='line'>    True
</span><span class='line'>[root@angel01 ~]# salt  '*'  test.ping
</span><span class='line'>angel01.i.fdmdns.com:
</span><span class='line'>    True
</span><span class='line'>angel02.i.fdmdns.com:
</span><span class='line'>    True
</span><span class='line'>[root@angel01 ~]# salt 'angel0[1-2].i.fdmdns.com'  test.ping
</span><span class='line'>angel01.i.fdmdns.com:
</span><span class='line'>    True
</span><span class='line'>angel02.i.fdmdns.com:
</span><span class='line'>    True
</span><span class='line'>[root@angel01 ~]# salt 'angel0*'  test.ping
</span><span class='line'>angel01.i.fdmdns.com:
</span><span class='line'>    True
</span><span class='line'>angel02.i.fdmdns.com:
</span><span class='line'>    True</span></code></pre></td></tr></table></div></figure>




<!-- more -->


<p>上面展示了匹配的方式<br/>
test.ping 是salt默认命令,主要测试客户端存活情况</p>

<p>另2个参数常用 <br/>
-E来使用正则表达式 <br/>
-L以列表的方式匹配</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@angel01 ~]# salt -E 'angel0\w'  test.ping
</span><span class='line'>angel01.i.fdmdns.com:
</span><span class='line'>    True
</span><span class='line'>angel02.i.fdmdns.com:
</span><span class='line'>    True
</span><span class='line'>[root@angel01 ~]# salt -L 'angel01.i.fdmdns.com,angel02.i.fdmdns.com'  test.ping
</span><span class='line'>angel01.i.fdmdns.com:
</span><span class='line'>    True
</span><span class='line'>angel02.i.fdmdns.com:
</span><span class='line'>    True</span></code></pre></td></tr></table></div></figure>


<p>主要的一些匹配演示如上</p>

<h2>cmd.run</h2>

<p>这个是可以批量执行shell命令,可以代替我们以前复杂的for的</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@angel01 ~]# salt -L 'angel01.i.fdmdns.com,angel02.i.fdmdns.com'  cmd.run "free -m|awk '/Mem:/{print \$2}'"
</span><span class='line'>angel01.i.fdmdns.com:
</span><span class='line'>    3702
</span><span class='line'>angel02.i.fdmdns.com:
</span><span class='line'>    1869</span></code></pre></td></tr></table></div></figure>


<h2>nodegroup</h2>

<p>nodegroup可以对我们现有的服务器进行分组,默认配置文件放在/etc/salt/master <br/>
这边为了更好的修改配置和区分,使用了default_include: /mnt/config/salt/master.d/*.conf</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cat /etc/salt/master
</span><span class='line'>include: /mnt/config/salt/master
</span><span class='line'>default_include: /mnt/config/salt/master.d/*.conf
</span><span class='line'>mkdir -p /mnt/config/salt/master.d/
</span><span class='line'>vim /mnt/config/salt/master.d/nodegroups.conf 
</span><span class='line'>#group#
</span><span class='line'>nodegroups:
</span><span class='line'>  web1:  'angel01.i.fdmdns.com' #测试机1为单独一组
</span><span class='line'>  web2:  'angel02.i.fdmdns.com' #测试机2为单独一租
</span><span class='line'>/etc/init.d/salt-master restart
</span><span class='line'>
</span><span class='line'>[root@angel01 ~]# salt -N 'web1' test.ping
</span><span class='line'>angel01.i.fdmdns.com:
</span><span class='line'>    True
</span><span class='line'>[root@angel01 ~]# salt -N 'web2' test.ping
</span><span class='line'>angel02.i.fdmdns.com:
</span><span class='line'>    True</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[saltstack config  (二)]]></title>
    <link href="http://leon8693.github.io/blog/2014/09/29/saltstack-config-2/"/>
    <updated>2014-09-29T17:08:00+08:00</updated>
    <id>http://leon8693.github.io/blog/2014/09/29/saltstack-config-2</id>
    <content type="html"><![CDATA[<p>原文出处:<a href="http://blog.coocla.org/301.html">http://blog.coocla.org/301.html</a></p>

<p>配置文件/etc/salt/master</p>

<p>interface  <br/>
默认接口：0.0.0.0（所有的网络地址接口）  <br/>
绑定到本地的某个网络接口</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ginterface: 192.168.0.1</span></code></pre></td></tr></table></div></figure>


<p>publish_port  <br/>
默认值：4505  <br/>
设置master与minion的认证通信端口</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gpublish_port: 4505</span></code></pre></td></tr></table></div></figure>


<p>user  <br/>
默认值：root  <br/>
运行salt进程的用户</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>user: root</span></code></pre></td></tr></table></div></figure>


<p>max_open_files  <br/>
每一个minion连接到master，至少要使用一个文件描述符，如果足够多的minion连接到master上，你将会从控制台上看到</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gsalt-master crashes：
</span><span class='line'>Too many open files (tcp_listener.cpp:335)
</span><span class='line'>Aborted (core dumped)</span></code></pre></td></tr></table></div></figure>


<p>默认值这个值取决于ulimit -Hn的值，即系统的对打开文件描述符的硬限制   <br/>
如果你希望重新设置改值或者取消设置，记住这个值不能超过硬限制，提高硬限制取决于你的操作系统或分配，一个好的方法是internet找到对应操作系统的硬限制设置，比如这样搜索：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>graise max open files hard limit debian
</span><span class='line'>max_open_files: 100000
</span><span class='line'>worker_threads</span></code></pre></td></tr></table></div></figure>


<p>默认值：5   <br/>
启动用来接收或应答minion的线程数。如果你有很多minion，而且minion延迟你的应答，你可以适度的提高该值. 在点对点的系统环境中使用时，该值不要被设置为3以下，但是可以将其设置为1</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gworker_threads: 5</span></code></pre></td></tr></table></div></figure>


<p>gret_port  <br/>
默认值：4506  <br/>
这个端口是master用来发送命令或者接收minions的命令执行返回信息</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gret_port: 4506</span></code></pre></td></tr></table></div></figure>


<p>pidfile  <br/>
默认值：/var/run/salt-master.pid <br/>
指定master的pid文件位置</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pidfile: /var/run/salt-master.pid</span></code></pre></td></tr></table></div></figure>


<p>root_dir  <br/>
默认值：/  <br/>
指定该目录为salt运行的根目录，改变它可以使salt从另外一个目录开始运行，好比chroot</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root_dir: /</span></code></pre></td></tr></table></div></figure>


<p>pki_dir  <br/>
默认值：/etc/salt/pki  <br/>
这个目录是用来存放pki认证秘钥</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pki_dir: /etc/salt/pki</span></code></pre></td></tr></table></div></figure>


<!-- more -->


<p>cachedir   <br/>
默认值：/var/cache/salt  <br/>
这个目录是用来存放缓存信息，特别是salt工作执行的命令信息</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cachedir: /var/cache/salt</span></code></pre></td></tr></table></div></figure>


<p>keep_jobs   <br/>
默认值：24  <br/>
设置保持老的工作信息的过期时间，单位小时  <br/>
job_cache  <br/>
默认值：True   <br/>
设置master维护的工作缓存，这是一个很好的功能，当你的Minons超过5000台时，他将很好的承担这个大的架构，关闭这个选项，之前的工作执行以及工作系统将无法被利用，一般不推荐关掉改选项，开启改选项将会是很明智的，他将使master获得更快的IO系统   <br/>
ext_job_cache   <br/>
对所有的minions使用指定的默认值returner，当使用了这个参数来指定一个returner并且配置正确，minions将会一直将返回的数据返回到returner，这也会默认值禁用master的本地缓存</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ext_job_cache: redis</span></code></pre></td></tr></table></div></figure>


<p>minion_data_cache  <br/>
默认值：True  <br/>
minion data cache是关于minion信息存储在master上的参数，这些信息主要是pillar 和 grains数据.这些数据被缓存在cachedir定义的目录下的minion目录下以minion名为名的目录下并且预先确定哪些minions将从执行回复</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>minion_cache_dir: True</span></code></pre></td></tr></table></div></figure>


<p>genforce_mine_cache  <br/>
默认值：False   <br/>
默认情况下当关闭了minion_data_cache，mine将会停止工作，因为mine是基于缓存数据，通过启用这个选项，我们将会显示的开启对于mine系统的缓存功能</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>genforce_mine_cache: False</span></code></pre></td></tr></table></div></figure>


<p>sock_dir   <br/>
默认值：/tmp/salt-unix  <br/>
指定unix socket主进程通信的socket创建路径</p>

<p>master的安全配置  <br/>
open_mode  <br/>
默认值：False  <br/>
open_mode是一个危险的安全特性，当master遇到pki认证系统，秘钥混淆和身份验证失效时，打开open_mode，master将会接受所有的身份验证。这将会清理掉pki秘钥接受的minions。通常情况下open_mode不应该被打开，它只适用于短时间内清理pki keys，若要打开它，可将值调整为True</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>open_mode: False</span></code></pre></td></tr></table></div></figure>


<p>auto_accept   <br/>
默认值：False   <br/>
开启auto_accept。这个设置将会使master自动接受所有发送公钥的minions</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>auto_accept: True</span></code></pre></td></tr></table></div></figure>


<p>autosign_file  <br/>
默认值：/etc/salt/autosign.conf  <br/>
如果autosign_file的值被指定，那么autosign_file将会通过该输入允许所有的匹配项，首先会搜索字符串进行匹配，然后通过正则表达式进行匹配。这是不安全的</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>autosign_file: /etc/salt/autosign.conf</span></code></pre></td></tr></table></div></figure>


<p>client_acl   <br/>
默认值：{}  <br/>
开启对系统上非root的系统用户在master上执行特殊的模块，这些模块名可以使用正则表达式进行表示</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gclient_acl:
</span><span class='line'>  fred:
</span><span class='line'>      - test.ping
</span><span class='line'>      - pkg.*</span></code></pre></td></tr></table></div></figure>


<p>client_acl_blacklist  <br/>
默认值：{}  <br/>
黑名单用户或模块  <br/>
这个例子表示所有非sudo用户以及root都无法通过cmd这个模块执行命令，默认情况改配置是完全禁用的</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gclient_acl_blacklist:
</span><span class='line'>  users:
</span><span class='line'>      - root
</span><span class='line'>      - '^(?!sudo_).*$'    # all non sudo users
</span><span class='line'>  modules:
</span><span class='line'>      - cmd</span></code></pre></td></tr></table></div></figure>


<p>external_auth   <br/>
默认值：{}  <br/>
salt的认证模块采用外部的认证系统用来做认证和验证用户在salt系统中的访问区域</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>external_auth:
</span><span class='line'>  pam:
</span><span class='line'>      fred:
</span><span class='line'>          - test.*</span></code></pre></td></tr></table></div></figure>


<p>token_expire    <br/>
默认：43200  <br/>
新令牌生成的时间间隔，单位秒，默认是12小时</p>

<p>token_expire: 43200  <br/>
file_recv  <br/>
默认值：False   <br/>
允许minions推送文件到master上，这个选项默认是禁用的，出于安全考虑</p>

<p>file_recv: False <br/>
master模块管理   <br/>
runner_dirs   <br/>
默认值：[] 设置搜索runner模块的额外路径</p>

<p>runner_dirs: []  <br/>
cython_enable  <br/>
默认值：False  <br/>
设置为true来开启对cython模块的编译</p>

<p>cython_enable: False <br/>
master状态系统设置   <br/>
state_verbose   <br/>
默认：False  <br/>
state_verbose允许从minions返回更多详细的信息，通常清空下只返回失败或者已经更改，但是将state_verbose设置为True,将会返回所有的状态检查</p>

<p>state_verbose: True <br/>
state_output  <br/>
默认值：full   <br/>
state_output的设置将会改变信息输出的格式，当被设置为”full”时，将全部的输出一行一行的显示输出；当被设置为”terse“时，将会被缩短为一行进行输出；当被设置为”mixed”时，输出样式将会是简洁的，除非状态失败，这种情况下将会全部输出；当被设置为”change”时，输出将会完全输出除非状态没有改变</p>

<p>state_output: full  <br/>
state_top   <br/>
默认值：top.sls  <br/>
状态系统使用一个入口文件告诉minions在什么环境下使用什么模块，这个状态入口文件被定义在基础环境的相对根路径下</p>

<p>state_top: top.sls <br/>
external_nodes   <br/>
默认值：None   <br/>
这个外部节点参数允许salt来收集一些数据，通常被放置在一个入口文件或外部节点控制器.外部节点的选择是可执行的，将会返回ENC数据，记住如果两者都启用的话salt会将外部节点和入口文件的结果进行综合汇总。</p>

<p>external_nodes: cobbler-ext-nodes <br/>
renderer  <br/>
默认值：yaml_jinja   <br/>
使用渲染器用来渲染minions的状态数据</p>

<p>renderer: yaml_jinja  <br/>
failhard  <br/>
默认值：False  <br/>
设置一个全局的failhard表示，当单个的状态执行失败后，将会通知所有的状态停止运行状态</p>

<p>failhard: False  <br/>
test   <br/>
默认值：False  <br/>
如果真的要作出改变或者仅仅通知将要执行什么改变时设置所有的状态调用为test</p>

<p>test: False <br/>
master文件服务器设置</p>

<p>fileserver_backend   <br/>
默认值：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>fileserver_backend:
</span><span class='line'>  - roots</span></code></pre></td></tr></table></div></figure>


<p>salt支持模块化的后端文件系统服务器，它允许salt通过第三方的系统来管理收集文件并提供给minions使用，可以配置多个后端文件系统，这里支持gitfs、hgfs、roots、s3fs文件调用的搜索顺序按照后台文件系统的配置顺序来搜索，默认的设置只开启了标准的后端服务器roots，具体的根选项配置通过file_roots参数设置</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gfileserver_backend:
</span><span class='line'>  - roots
</span><span class='line'>  - gitfs</span></code></pre></td></tr></table></div></figure>


<p>file_roots   <br/>
默认值：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>base:
</span><span class='line'>  - /srv/salt</span></code></pre></td></tr></table></div></figure>


<p>salt运行一个轻量级的文件服务器通过ZeroMQ对minions进行文件传输，因此这个文件服务器是构造在master的守护进程中，并且不需要依赖于专用的端口 文件服务器的工作环境传递给master，每一个环境可以有多个跟目录，但是相同环境下多个文件的子目录不能相同，否则下载的文件将不能被可靠的保证，一个基础环境依赖于主的入口文件，如：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>file_roots:
</span><span class='line'>  base:
</span><span class='line'>     - /srv/salt
</span><span class='line'>  dev:
</span><span class='line'>     - /srv/salt/dev/services
</span><span class='line'>     - /srv/salt/dev/states
</span><span class='line'>  prod:
</span><span class='line'>     - /srv/salt/prod/services
</span><span class='line'>     - /srv/salt/prod/states</span></code></pre></td></tr></table></div></figure>


<p>hash_type <br/>
默认值：md5  <br/>
hash_type是用来当发现在master上需要对一个文件进行hash时的hash使用的算法，默认是md5.但是它也支持sha1,sha224,shar256,shar384,shar512</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>hash_type: md5</span></code></pre></td></tr></table></div></figure>


<p>file_buffer_size  <br/>
默认值：1048576  <br/>
文件服务器的缓存区大小</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>file_buffer_size: 1048576</span></code></pre></td></tr></table></div></figure>


<p>pillar配置   <br/>
pillar_roots   <br/>
默认值：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>base:
</span><span class='line'>  - /srv/pillar</span></code></pre></td></tr></table></div></figure>


<p>设置不同的环境对应的存放pillar数据的目录，这个配置和file_roots参数配置一样</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pillar_roots:
</span><span class='line'>  base:
</span><span class='line'>     - /srv/pillar
</span><span class='line'>  dev:
</span><span class='line'>     - /srv/pillar/dev
</span><span class='line'>  prod:
</span><span class='line'>      - /srv/pillar/prod</span></code></pre></td></tr></table></div></figure>


<p>ext_pillar   <br/>
当进行pillar数据收集时，这个ext_pillar参数允许调用任意数量的外部pillar接口，这个配置是基于ext_pillar函数，你可以从这个找到这个函数<a href="https://github.com/saltstack/salt/blob/develop/salt/pillar">https://github.com/saltstack/salt/blob/develop/salt/pillar</a>   <br/>
默认情况下，这个ext_pillar接口没有配置运行   <br/>
默认值：None</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ext_pillar:
</span><span class='line'>  - hiera: /etc/hiera.yaml
</span><span class='line'>  - cmd_yaml: cat /etc/salt/yaml
</span><span class='line'>  - reclass:
</span><span class='line'>     inventory_base_uri: /etc/reclass</span></code></pre></td></tr></table></div></figure>


<p>从这里可以查到pillar的一些额外细节</p>

<p>syndic server配置</p>

<p>syncdic是salt master用来通过从整体架构中高于自己层级的master或者syndic接收命令传递给minions的中间角色。使用syndic非常简单，如果这个master在整体架构中，他的下级存在syndic server，那么需要将master的配置文件中的”order_master”值设置为True，如果这个master还需要运行一个syndic进程，扮演另外一个角色，那么需要设置主master server的信息(上一级master)    <br/>
千万别忘记了，这将意味着它将与其他master共享它的minion的id和pki_dir</p>

<p>order_masters   <br/>
默认值：False   <br/>
当额外的数据需要发送和传递，并且这个master控制的minions是被低等级的master或syndic直接管理下，那么”order_masters”这个值必须得设置为True</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>order_master: False</span></code></pre></td></tr></table></div></figure>


<p>syndic_master   <br/>
默认值：None   <br/>
如果这个master运行的salt-syndic连接到了一个更高层级的master,那么这个参数需要配置成连接到的这个高层级的master的地址</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>syndic_master: masterofmasters</span></code></pre></td></tr></table></div></figure>


<p>syndic_master_port   <br/>
默认值：4506   <br/>
如果这个master运行的salt-syndic连接到了一个更高层级的master,那么这个参数需要配置成连接到的这个高层级master的监听端口</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>syndic_master_port: 4506</span></code></pre></td></tr></table></div></figure>


<p>syndic_log_file   <br/>
默认值：syndic.log    <br/>
为syndic进程指定日志文件</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>syndic_log_file: salt-syndic.log</span></code></pre></td></tr></table></div></figure>


<p>syndic_pidfile   <br/>
默认值：salt-syndic.pid  <br/>
为syndic进程指定pid文件</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>syndic_pidfile: syndic.pid</span></code></pre></td></tr></table></div></figure>


<p>Peer Publish设置    <br/>
salt minions可以向其他minions发送命令，但是仅仅在minion允许的情况下。默认情况下”Peer Publication”是关闭的，当需要开启的时候，需要开启对应的minion和对应的命令，这样可以允许根据个人的minions安全的划分出命令   <br/>
peer   <br/>
默认值：{}    <br/>
这个配置使用正则表达式去匹配minions并且是一个正则表达式列表函数，下面这个例子将允许名为foo.example.com的minion认证通过后执行test和pkg模块中的函数</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>peer:
</span><span class='line'>  foo.example.com:
</span><span class='line'>     - test.*
</span><span class='line'>     - pkg.*</span></code></pre></td></tr></table></div></figure>


<p>这将允许所有的minion执行所有的命令</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>peer:
</span><span class='line'>  .*:
</span><span class='line'>     - .*</span></code></pre></td></tr></table></div></figure>


<p>这样的配置是极不推荐的，因为任何人得到架构中的任何一个minion即可拥有所有的minions，这是不安全的</p>

<p>peer_run   <br/>
默认值：{}               <br/>
peer_run参数是用来打开runners在master所允许的minions上，peer_run的配置匹配格式和peer参数的配置一样 下面这个例子允许foo.example.com的minion执行manage.up runner</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>peer_run:
</span><span class='line'>  foo.example.com:
</span><span class='line'>     - manage.up</span></code></pre></td></tr></table></div></figure>


<p>nodegroups  <br/>
默认值：{}  <br/>
minions允许通过node groups来分成多个逻辑组，每个组由一个组名和复合模式组成</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>nodegroups:
</span><span class='line'>  group1: 'L@foo.domain.com,bar.domain.com,baz.domain.com or bl*.domain.com'
</span><span class='line'>  group2: 'G@os:Debian and foo.domain.com'</span></code></pre></td></tr></table></div></figure>


<p>Master日志设置   <br/>
log_file  <br/>
默认值：/var/log/salt/master  <br/>
master的日志可以发送到一个普通文件，本地路径名或者网络位置，更多详情请访问 <a href="http://docs.saltstack.com/ref/configuration/logging/index.html#std:conf-log-log_file">http://docs.saltstack.com/ref/configuration/logging/index.html#std:conf-log-log_file</a>   <br/>
例如：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>log_file: /var/log/salt/master
</span><span class='line'>log_file: file:///dev/log
</span><span class='line'>log_file: udp://loghost:10514</span></code></pre></td></tr></table></div></figure>


<p>log_level     <br/>
默认值：warning     <br/>
按照日志级别发送信息到控制台，更多详情请访问 <a href="http://docs.saltstack.com/ref/configuration/logging/index.html#std:conf-log-log_level">http://docs.saltstack.com/ref/configuration/logging/index.html#std:conf-log-log_level</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>log_level: warning</span></code></pre></td></tr></table></div></figure>


<p>log_level_logfile    <br/>
默认值：warning     <br/>
按照日志级别发送信息到日志文件，更多详情请访问 <a href="http://docs.saltstack.com/ref/configuration/logging/index.html#std:conf-log-log_level_logfile">http://docs.saltstack.com/ref/configuration/logging/index.html#std:conf-log-log_level_logfile</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>log_level_logfile: warning</span></code></pre></td></tr></table></div></figure>


<p>log_datefmt     <br/>
默认值：%H:%M:%S    <br/>
发送到控制台信息所用的日期时间格式，更多详情请访问 <a href="http://docs.saltstack.com/ref/configuration/logging/index.html#std:conf-log-log_datefmt">http://docs.saltstack.com/ref/configuration/logging/index.html#std:conf-log-log_datefmt</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>log_datefmt: '%H:%M:%S'</span></code></pre></td></tr></table></div></figure>


<p>log_datefmt_logfile     <br/>
默认值: %Y-%m-%d %H:%M:%S     <br/>
发送到日志文件信息所用的日期时间格式，更多详情请访问 <a href="http://docs.saltstack.com/ref/configuration/logging/index.html#std:conf-log-log_datefmt_logfile">http://docs.saltstack.com/ref/configuration/logging/index.html#std:conf-log-log_datefmt_logfile</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>log_datefmt_logfile: '%Y-%m-%d %H:%M:%S'</span></code></pre></td></tr></table></div></figure>


<p>log_fmt_console     <br/>
默认值: [%(levelname)-8s] %(message)s     <br/>
控制台日志信息格式，更多详情请访问 <a href="http://docs.saltstack.com/ref/configuration/logging/index.html#std:conf-log-log_fmt_console">http://docs.saltstack.com/ref/configuration/logging/index.html#std:conf-log-log_fmt_console</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>log_fmt_console: '[%(levelname)-8s] %(message)s'</span></code></pre></td></tr></table></div></figure>


<p>log_fmt_logfile     <br/>
默认值: %(asctime)s,%(msecs)03.0f [%(name)-17s][%(levelname)-8s] %(message)s     <br/>
%(asctime)s：2003-07-08 16:49:45     <br/>
%(msecs)03.0f：当前时间的毫秒部分    <br/>
%(name)：日志记录调用器的名字    <br/>
%(levelname)：日志记录级别    <br/>
%(message)s：日志详细信息    <br/>
日志文件信息格式，更多详情请访问 <a href="http://docs.saltstack.com/ref/configuration/logging/index.html#std:conf-log-log_fmt_logfile">http://docs.saltstack.com/ref/configuration/logging/index.html#std:conf-log-log_fmt_logfile</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>log_fmt_logfile: '%(asctime)s,%(msecs)03.0f [%(name)-17s][%(levelname)-8s] %(message)s'</span></code></pre></td></tr></table></div></figure>


<p>log_granular_levels</p>

<p>默认值：{}    <br/>
这可以更加具体的控制日志记录级别，更多详情请访问 <a href="http://docs.saltstack.com/ref/configuration/logging/index.html#std:conf-log-log_granular_levels">http://docs.saltstack.com/ref/configuration/logging/index.html#std:conf-log-log_granular_levels</a></p>

<p>Include 配置</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>default_include</span></code></pre></td></tr></table></div></figure>


<p>默认值：master.d/<em>.conf    <br/>
master可以从其他文件读取配置，默认情况下master将自动的将master.d/</em>.conf中的配置读取出来并应用，其中master.d目录是相对存在于主配置文件所在的目录    <br/>
include     <br/>
默认值：not defined     <br/>
master可以包含其他文件中的配置，要启用此功能，通过此参数定义路径或文件，此路径可以是相对的也可以是绝对的，相对的，会被看作相对于主配置文件所在的目录，路径中还可以使用类似于shell风格的通配符，如果没有文件匹配的路径传递给此选项，那么master将会在日志中记录一条警告的消息</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Include files from a master.d directory in the same
</span><span class='line'>    # directory as the master config file
</span><span class='line'>    include: master.d/*
</span><span class='line'>
</span><span class='line'># Include a single extra file into the configuration
</span><span class='line'>include: /etc/roles/webserver
</span><span class='line'>
</span><span class='line'># Include several files and the master.d directory
</span><span class='line'>include:
</span><span class='line'>  - extra_config
</span><span class='line'>  - master.d/*
</span><span class='line'>  - /etc/roles/webserver</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[saltstack install (一)]]></title>
    <link href="http://leon8693.github.io/blog/2014/09/29/saltstack-install-1/"/>
    <updated>2014-09-29T16:14:00+08:00</updated>
    <id>http://leon8693.github.io/blog/2014/09/29/saltstack-install-1</id>
    <content type="html"><![CDATA[<h1>下载安装</h1>

<h5>Centos</h5>

<p>epel源或者centos源都有</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>yum install salt-master -y #服务端
</span><span class='line'>yum install salt-minion -y #客户端</span></code></pre></td></tr></table></div></figure>


<h5>Ubuntu</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo apt-get install python-software-properties
</span><span class='line'>echo deb http://ppa.launchpad.net/saltstack/salt/ubuntu `lsb_release -sc` main | sudo tee   
</span><span class='line'>/etc/apt/sources.list.d/saltstack.list
</span><span class='line'>wget -q -O- "http://keyserver.ubuntu.com:11371/pks/lookup?op=get&amp;search=0x4759FA960E27C0A6" |sudo apt-key add -
</span><span class='line'>sudo apt-get update
</span><span class='line'>sudo apt-get install salt-master
</span><span class='line'>sudo apt-get install salt-minion</span></code></pre></td></tr></table></div></figure>


<p>由于我配置文件目录更改,所以有些增加的选项都是非必要的,参考即可</p>

<h3>master配置</h3>

<p>vim /etc/salt/master  配置文件</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>include: /mnt/config/salt/master
</span><span class='line'>default_include: /mnt/config/salt/master.d/*.conf
</span><span class='line'>mkdir -p /mnt/config/salt/ /mnt/config/salt/master.d/</span></code></pre></td></tr></table></div></figure>


<!-- more -->


<p>vim /mnt/config/salt/master #主配置文件</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>interface: 192.168.0.210
</span><span class='line'>user: root
</span><span class='line'>auto_accept: True     #自动认证
</span><span class='line'>worker_threads: 5     #工作线程，默认5，根据cpu调整</span></code></pre></td></tr></table></div></figure>


<p>PS: /mnt/config/salt/master.d/ 这个目录会在下篇里面说到</p>

<p>/etc/init.d/salt-master start #启动</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#表示启动成功
</span><span class='line'>[root@angel01 ~]# netstat -lntp |grep -E "450[5|6]"
</span><span class='line'>tcp        0      0 192.168.0.210:4505          0.0.0.0:*                   LISTEN      20004/python2.6    
</span><span class='line'>tcp        0      0 192.168.0.210:4506          0.0.0.0:*                   LISTEN      19996/python2.6   </span></code></pre></td></tr></table></div></figure>


<h3>minion配置</h3>

<p>vim /etc/salt/minion 配置文件</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>include: /mnt/config/salt/minion</span></code></pre></td></tr></table></div></figure>


<p>vim /mnt/config/salt/minion</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>master: angel01.i.fdmdns.com    #master地址
</span><span class='line'>user: root                      #启动用户
</span><span class='line'>id: angel01.i.fdmdns.com        #这个就是服务器用来标示客户端的东西</span></code></pre></td></tr></table></div></figure>


<p>/etc/init.d/salt-minion start #启动</p>

<p>第一次启动minion,minion会生成钥匙</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@angel01 /]# tree /etc/salt/pki/minion/
</span><span class='line'>/etc/salt/pki/minion/
</span><span class='line'>├── minion_master.pub
</span><span class='line'>├── minion.pem
</span><span class='line'>└── minion.pub</span></code></pre></td></tr></table></div></figure>


<h3>手动认证</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@angel01 ~]# salt-key
</span><span class='line'>Accepted Keys:             #验证通过
</span><span class='line'>Unaccepted Keys:          #等待验证的
</span><span class='line'>angel01.i.fdmdns.com
</span><span class='line'>Rejected Keys:               #拒绝
</span><span class='line'>
</span><span class='line'>[root@angel01 ~]# salt-key -A
</span><span class='line'>接受所有key</span></code></pre></td></tr></table></div></figure>


<h3>salt-key的基本命令</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>salt-key -L #检测当前server端所有minion端key的情况，三种：接收、等待接收和拒绝
</span><span class='line'>salt-key -a hostname #指定接收某台minion的key
</span><span class='line'>salt-key -A #接收Unaccepted Keys下所有的minion
</span><span class='line'>salt-key -d hostname #删除已经接收的机器中指定机器minion key (Accepted Keys:)
</span><span class='line'>salt-key -D #删除已经接收的所有机器(Accepted Keys:)</span></code></pre></td></tr></table></div></figure>


<h3>测试</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@angel01 ~]# salt '*' test.ping
</span><span class='line'>angel01.i.fdmdns.com:
</span><span class='line'>    True
</span><span class='line'>angel02.i.fdmdns.com:
</span><span class='line'>    True</span></code></pre></td></tr></table></div></figure>


<p>表示成功了！</p>

<h3>问题集合</h3>

<p>问题1 <br/>
ImportError: No module named salt.scripts <br/>
yum 的情况下salt的模块都安装在python2.6 进入/etc/init.d/salte-master进行修改</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>批量修改命令
</span><span class='line'>sed -i "s/^#\!\/usr\/bin\/python$/#\!\/usr\/bin\/python2.6/g" /usr/bin/salt-*
</span><span class='line'>批量修改启动命令
</span><span class='line'>sed -i "s/^PYTHON=\/usr\/bin\/python$/PYTHON=\/usr\/bin\/python2.6/g" /etc/init.d/salt-*</span></code></pre></td></tr></table></div></figure>


<p>问题2 <br/>
[root@angel01 ~]# salt  &lsquo;angel01.i.fdmdns.com&rsquo; test.ping  <br/>
[ERROR   ] Salt request timed out. If this error persists, worker_threads may need to be increased. <br/>
Failed to authenticate, is this user permitted to execute commands?  <br/>
由于修改过启动配置文件直接读取/mnt/config/salt/导致,最后改成/etc/salt/master 添加include解决</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[maptail展现中国地图]]></title>
    <link href="http://leon8693.github.io/blog/2014/08/01/maptailzhan-xian-zhong-guo-di-tu/"/>
    <updated>2014-08-01T16:29:00+08:00</updated>
    <id>http://leon8693.github.io/blog/2014/08/01/maptailzhan-xian-zhong-guo-di-tu</id>
    <content type="html"><![CDATA[<h3>声明</h3>

<p>本篇文章转自王强blog<br/>
blog地址:<a href="http://qiangwang.github.io/2013/01/27/maptail-china-map.html">maptail展现中国地图</a> <br/>
github地址:<a href="https://github.com/qiangwang/maptail">maptail-github</a></p>

<h1>maptail</h1>

<p><img src="http://qiangwang.github.io/img/maptail-china-map.png" border="0" /></p>

<p>maptail is a realtime map view of GeoIP data. Attach it to your server to track visitors, tail a log, pipe to its stdin or use it as a library to build your own implementation. Just emit IP addresses to it from any source and you&rsquo;ll automagically get a cool map with yellow dots and stuff like that streamed in with websockets or whatever transport you&rsquo;d like to use.</p>

<h2>Installing</h2>

<p><code>npm install maptail -g</code></p>

<p>Omit the <code>-g</code> to install as a module.</p>

<h2>How to use</h2>

<h3>The command line tool:</h3>

<p><code>$ maptail -f nohup.out</code></p>

<p><code>$ tail -f nohup.out | maptail -h my.host.com -p 3000</code></p>

<!-- more -->


<h3>In your server:</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">maptail</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;maptail&#39;</span><span class="p">)</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">)</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">.</span><span class="nx">createServer</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">maptail</span><span class="p">.</span><span class="nx">track</span><span class="p">())</span>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/map&#39;</span><span class="p">,</span> <span class="nx">maptail</span><span class="p">.</span><span class="kr">static</span><span class="p">())</span>
</span><span class='line'>
</span><span class='line'><span class="nx">maptail</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">8080</span><span class="p">,</span> <span class="s1">&#39;localhost&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let me explain what these are doing here a bit. <code>maptail.track()</code> tracks visitors&#8217; IPs and emits them to maptail. <code>maptail.static()</code> is an <code>express.static()</code> middleware that points to our static data (maptail.html, css, etc.)</p>

<p><code>maptail.attach(app)</code> attaches a <a href="https://github.com/stagas/simpl">simpl</a> WebSocket server which makes it possible for our frontend app to easily subscribe to the GeoIP data events sent by maptail and display them on the map.</p>

<p>If for example you don&rsquo;t want to track visitors of the http server but instead you want to send IPs from another source, you can easily remove <code>maptail.track()</code> from the middleware and use <code>maptail.emit('ip', ipAddress[, logMessage])</code> to feed our map. It will take care the rest for you.</p>

<h2>Credits</h2>

<p>This is based on <a href="https://github.com/mape">mape</a>&rsquo;s <a href="https://github.com/mape/node-wargames">wargames</a>.</p>

<p><a href="https://github.com/bluesmoon/node-geoip">geoip-lite</a> by <a href="https://github.com/bluesmoon">Philip Tellis</a>.</p>

<p>Earlier versions used <a href="https://github.com/kuno">kuno</a>&rsquo;s <a href="https://github.com/kuno/GeoIP">GeoIP</a> module but since it now uses a C library, I couldn&rsquo;t use it.</p>

<p><a href="http://www.maxmind.com/">MaxMind</a> for their free to use GeoIP data.</p>

<h2>Licence</h2>

<p>maptail is MIT/X11. The rest of the components are of their respective licences.</p>

<h2>Nginx配置</h2>

<p>本人使用后非常好,这得感谢王强的付出和共享,随后我将这个通过nginx转发,发现通过nginx代理后页面变成静态了,这个是怎么回事?<br/>
原本想研究一下,但迫于工作原因,没时间仔细看,不过和同事分享的时候发现了是websocket的问题,这得感谢@朱总的提议,随后查看页面如下<br/>
<img src="http://leon8693.github.io/images/blog_img/maptail01.png" alt="maptail01" /></p>

<p>确确实实就是websocket问题<br/>
接下来我们来解决它,嘿嘿<br/>
官方参考:<a href="http://nginx.org/en/docs/http/websocket.html  ">http://nginx.org/en/docs/http/websocket.html  </a>
使用这些配置即可使nginx支持websocket</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">server</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">listen</span> <span class="mi">80</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">server_name</span> <span class="nx">_</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">access_log</span>  <span class="o">/</span><span class="nx">data1</span><span class="o">/</span><span class="nx">logs</span><span class="o">/</span><span class="nx">nginx</span><span class="o">/</span><span class="nx">access</span><span class="p">.</span><span class="nx">log</span>  <span class="nx">gzip</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">error_log</span>   <span class="o">/</span><span class="nx">data1</span><span class="o">/</span><span class="nx">logs</span><span class="o">/</span><span class="nx">nginx</span><span class="o">/</span><span class="nx">error</span><span class="p">.</span><span class="nx">log</span> <span class="nx">error</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">location</span> <span class="o">/</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">proxy_pass</span> <span class="nx">http</span><span class="o">:</span><span class="c1">//test;</span>
</span><span class='line'>                <span class="nx">proxy_http_version</span> <span class="mf">1.1</span><span class="p">;</span>
</span><span class='line'>                <span class="nx">proxy_set_header</span> <span class="nx">Upgrade</span> <span class="nx">$http_upgrade</span><span class="p">;</span>
</span><span class='line'>                <span class="nx">proxy_set_header</span> <span class="nx">Connection</span> <span class="s2">&quot;upgrade&quot;</span><span class="p">;</span>
</span><span class='line'>                <span class="nx">proxy_set_header</span> <span class="nx">Host</span> <span class="nx">$host</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>OK 完成！</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Redis Sentinel HA自动切换]]></title>
    <link href="http://leon8693.github.io/blog/2014/06/13/redis-sentinel-hazi-dong-qie-huan/"/>
    <updated>2014-06-13T17:11:00+08:00</updated>
    <id>http://leon8693.github.io/blog/2014/06/13/redis-sentinel-hazi-dong-qie-huan</id>
    <content type="html"><![CDATA[<h2>Redis Sentinel  HA自动切换</h2>

<h3>redis 2.8.11 下载</h3>

<p><a href="http://redis.io/download">http://redis.io/download</a>  <br/>
<a href="http://download.redis.io/releases/redis-2.8.11.tar.gz">http://download.redis.io/releases/redis-2.8.11.tar.gz</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>master 192.168.0.210
</span><span class='line'>slave 192.168.0.211
</span><span class='line'>slave 192.168.0.213
</span><span class='line'>
</span><span class='line'>#安装redis 2.8.11
</span><span class='line'>cd /srv/
</span><span class='line'>tar xf redis-2.8.11.tar.gz
</span><span class='line'>cd redis-2.8.11
</span><span class='line'>make && make install 
</span><span class='line'>
</span><span class='line'>#复制启动文件
</span><span class='line'>cp -rp /srv/redis-2.8.11/utils/redis_init_script  /etc/init.d/redis
</span><span class='line'>chmod +x /etc/init.d/redis
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>#master 配置文件
</span><span class='line'>/etc/redis/redis.conf
</span><span class='line'>####
</span><span class='line'>daemonize yes
</span><span class='line'>pidfile /var/run/redis/redis.pid
</span><span class='line'>port 6379
</span><span class='line'>bind 0.0.0.0
</span><span class='line'>timeout 0
</span><span class='line'>loglevel notice
</span><span class='line'>logfile /var/log/redis/redis.log
</span><span class='line'>databases 16
</span><span class='line'>save 900 1
</span><span class='line'>save 300 10
</span><span class='line'>save 60 10000
</span><span class='line'>rdbcompression yes
</span><span class='line'>dbfilename dump.rdb
</span><span class='line'>dir /var/lib/redis/
</span><span class='line'>slave-serve-stale-data yes
</span><span class='line'>appendonly no
</span><span class='line'>appendfsync everysec
</span><span class='line'>no-appendfsync-on-rewrite no
</span><span class='line'>auto-aof-rewrite-percentage 100
</span><span class='line'>auto-aof-rewrite-min-size 64mb
</span><span class='line'>slowlog-log-slower-than 10000
</span><span class='line'>slowlog-max-len 1024
</span><span class='line'>list-max-ziplist-entries 512
</span><span class='line'>list-max-ziplist-value 64
</span><span class='line'>set-max-intset-entries 512
</span><span class='line'>zset-max-ziplist-entries 128
</span><span class='line'>zset-max-ziplist-value 64
</span><span class='line'>activerehashing yes
</span><span class='line'>requirepass angel01
</span><span class='line'>slave-read-only yes
</span><span class='line'>maxmemory 1G
</span><span class='line'>########
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>#slave配置
</span><span class='line'>########
</span><span class='line'>daemonize yes
</span><span class='line'>pidfile /var/run/redis/redis.pid
</span><span class='line'>port 6379
</span><span class='line'>bind 0.0.0.0
</span><span class='line'>timeout 0
</span><span class='line'>loglevel notice
</span><span class='line'>logfile /var/log/redis/redis.log
</span><span class='line'>databases 16
</span><span class='line'>save 900 1
</span><span class='line'>save 300 10
</span><span class='line'>save 60 10000
</span><span class='line'>rdbcompression yes
</span><span class='line'>dbfilename dump.rdb
</span><span class='line'>dir /var/lib/redis/
</span><span class='line'>slave-serve-stale-data yes
</span><span class='line'>appendonly yes
</span><span class='line'>appendfsync everysec
</span><span class='line'>no-appendfsync-on-rewrite no
</span><span class='line'>auto-aof-rewrite-percentage 100
</span><span class='line'>auto-aof-rewrite-min-size 64mb
</span><span class='line'>slowlog-log-slower-than 10000
</span><span class='line'>slowlog-max-len 1024
</span><span class='line'>list-max-ziplist-entries 512
</span><span class='line'>list-max-ziplist-value 64
</span><span class='line'>set-max-intset-entries 512
</span><span class='line'>zset-max-ziplist-entries 128
</span><span class='line'>zset-max-ziplist-value 64
</span><span class='line'>activerehashing yes
</span><span class='line'>slave-serve-stale-data yes
</span><span class='line'>slaveof 192.168.0.210 6379
</span><span class='line'>masterauth angel01
</span><span class='line'>slave-read-only yes
</span><span class='line'>maxmemory 1G
</span><span class='line'>#############
</span></code></pre></td></tr></table></div></figure>


<!-- more -->


<p>可以通过以下2种方式查看是否主从<br/>
方案1</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>redis-cli -a angel01 -h 192.168.0.210 info Replication
</span><span class='line'># Replication
</span><span class='line'>role:master
</span><span class='line'>connected_slaves:2
</span><span class='line'>slave0:ip=192.168.0.211,port=6379,state=online,offset=21327,lag=1
</span><span class='line'>slave1:ip=192.168.0.213,port=6379,state=online,offset=21327,lag=1
</span><span class='line'>master_repl_offset:21327
</span><span class='line'>repl_backlog_active:1
</span><span class='line'>repl_backlog_size:1048576
</span><span class='line'>repl_backlog_first_byte_offset:2
</span><span class='line'>repl_backlog_histlen:21326</span></code></pre></td></tr></table></div></figure>


<p>方案2</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>master 上操作
</span><span class='line'>redis-cli -a angel01
</span><span class='line'>set leon good
</span><span class='line'>slave 上操作
</span><span class='line'>redis-cli -a angel01
</span><span class='line'>get leon
</span><span class='line'>"good"
</span><span class='line'>即可成功</span></code></pre></td></tr></table></div></figure>


<p><code>slave-read-only yes</code> 从只有只读权限<br/>
<code>maxmemory 1G</code>        最大使用内存1G<br/>
<code>appendonly yes</code>      slave 上，开启aof备份，路径在dir /var/lib/redis/下面</p>

<p>这边需要注意的是，AOF和RDB的备份，在主上只开启RDB，在SLAVE上2个都开启，但在故障转移的时候slave升成master时，压力会比原来的master大，那是因为RDB和AOF是不会自动转移的。
到此说明redis正常工作了，接下来开始使用哨兵sentinel进行监控以及主从切换</p>

<p>如下操作</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cp -rp /srv/redis-2.8.11/sentinel.conf /etc/redis/
</span><span class='line'>vim /etc/redis/sentinel.conf
</span><span class='line'>port 26379
</span><span class='line'>dir /var/lib/redis
</span><span class='line'>sentinel monitor mymaster 192.168.0.210 6379 2
</span><span class='line'>sentinel down-after-milliseconds mymaster 30000
</span><span class='line'>sentinel parallel-syncs mymaster 1
</span><span class='line'>sentinel failover-timeout mymaster 180000
</span><span class='line'>sentinel auth-pass mymaster angel01
</span><span class='line'>/etc/init.d/redis-sentinel /etc/sentinel.conf --sentinel  #启动命令</span></code></pre></td></tr></table></div></figure>


<h3>故障演示</h3>

<p>3台机器都启动查看<br/>
redis-cli -h 192.168.0.210 -p 26379 info Sentinel 可以查看信息<br/>
关闭slave<br/>
没有任何响应</p>

<p>关闭master<br/>
<img src="http://leon8693.github.io/images/blog_img/redis1.png" alt="stop_master" />
可以看到213接替了210成了master<br/>
到此完成切换</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[python OptionParser]]></title>
    <link href="http://leon8693.github.io/blog/2014/06/06/python-optionparser/"/>
    <updated>2014-06-06T15:28:00+08:00</updated>
    <id>http://leon8693.github.io/blog/2014/06/06/python-optionparser</id>
    <content type="html"><![CDATA[<h2>脚本原型</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/python</span>
</span><span class='line'><span class="c">#-*- coding:utf-8 -*</span>
</span><span class='line'><span class="c">#django添加数据库用户密码</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">os</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">optparse</span> <span class="kn">import</span> <span class="n">OptionParser</span>
</span><span class='line'>
</span><span class='line'><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span> <span class="s">&quot;DJANGO_SETTINGS_MODULE&quot;</span><span class="p">,</span> <span class="s">&quot;mysite.settings&quot;</span> <span class="p">)</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">accounts.models</span> <span class="kn">import</span> <span class="n">User</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">hashlib</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c">###编码转移,可以输出中文####</span>
</span><span class='line'><span class="nb">reload</span><span class="p">(</span><span class="n">sys</span><span class="p">)</span>
</span><span class='line'><span class="n">sys</span><span class="o">.</span><span class="n">setdefaultencoding</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c">###%prog表示脚本本身</span>
</span><span class='line'><span class="n">MSG_USAGE</span> <span class="o">=</span> <span class="s">&quot;%prog [ -u &lt;username&gt;][-p &lt;password&gt;][-t &lt;user_type&gt;][-h &lt;help&gt;]&quot;</span>
</span><span class='line'><span class="n">MSG_VERSION</span> <span class="o">=</span> <span class="s">&quot;%prog 20140529&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c">###usage打印用法,version输出版本信息</span>
</span><span class='line'><span class="n">optParser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">(</span><span class="n">usage</span><span class="o">=</span><span class="n">MSG_USAGE</span><span class="p">,</span><span class="n">version</span><span class="o">=</span><span class="n">MSG_VERSION</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c">###对optParser增加选项</span>
</span><span class='line'><span class="n">optParser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-u&quot;</span><span class="p">,</span><span class="s">&quot;--username&quot;</span><span class="p">,</span><span class="n">action</span> <span class="o">=</span> <span class="s">&quot;store&quot;</span><span class="p">,</span><span class="nb">type</span> <span class="o">=</span> <span class="s">&quot;string&quot;</span><span class="p">,</span><span class="n">dest</span> <span class="o">=</span> <span class="s">&quot;UserName&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;添加数据库用户名(必填)&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">optParser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-p&quot;</span><span class="p">,</span><span class="s">&quot;--password&quot;</span><span class="p">,</span><span class="n">action</span> <span class="o">=</span> <span class="s">&quot;store&quot;</span><span class="p">,</span><span class="nb">type</span> <span class="o">=</span> <span class="s">&quot;string&quot;</span><span class="p">,</span><span class="n">dest</span> <span class="o">=</span> <span class="s">&quot;Password&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;添加数据库密码(必填)&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">optParser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-t&quot;</span><span class="p">,</span><span class="s">&quot;--user_type&quot;</span><span class="p">,</span><span class="n">action</span> <span class="o">=</span> <span class="s">&quot;store&quot;</span><span class="p">,</span><span class="nb">type</span> <span class="o">=</span> <span class="s">&quot;string&quot;</span><span class="p">,</span><span class="n">dest</span> <span class="o">=</span> <span class="s">&quot;User_Type&quot;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="s">&quot;1&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;添加用户权限,0为管理员,1为普通,默认为1&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c">#fakeArgs = [&#39;-u&#39;,&#39;leon&#39;,&#39;-p&#39;,&#39;123456&#39;,&#39;-t&#39;,&#39;a&#39;]</span>
</span><span class='line'><span class="n">options</span><span class="p">,</span><span class="n">args</span> <span class="o">=</span> <span class="n">optParser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">TYPE</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">User_Type</span>
</span><span class='line'><span class="n">USERNAME</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">UserName</span>
</span><span class='line'><span class="n">PASSWORD</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">Password</span>
</span><span class='line'>
</span><span class='line'><span class="c">#User_Type返回不是1或者0则退出</span>
</span><span class='line'><span class="k">if</span> <span class="n">TYPE</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;1&#39;</span><span class="p">,</span><span class="s">&#39;0&#39;</span><span class="p">):</span>
</span><span class='line'>    <span class="n">optParser</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
</span><span class='line'>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c">#判断参数-u,-p是否为空,返回帮助</span>
</span><span class='line'><span class="n">args_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">USERNAME</span><span class="p">,</span><span class="n">PASSWORD</span><span class="p">]</span>
</span><span class='line'><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">args_list</span><span class="p">:</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&#39;请使用(-h,--help)来获得帮助&#39;</span>
</span><span class='line'>        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c">#User是在accounts中models.py的类,定义了数据库的一些信息,插入用户</span>
</span><span class='line'><span class="c">#判断用户是否存在</span>
</span><span class='line'><span class="k">def</span> <span class="nf">init</span><span class="p">():</span>
</span><span class='line'>    <span class="n">CHECK_NAME</span><span class="o">=</span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">USERNAME</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">CHECK_NAME</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> 用户已经存在&quot;</span> <span class="o">%</span> <span class="n">USERNAME</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">USERNAME</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">PASSWORD</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(),</span> <span class="n">user_type</span><span class="o">=</span><span class="n">TYPE</span><span class="p">)</span>
</span><span class='line'>        <span class="n">u</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="s">&#39;__main__&#39;</span> <span class="o">==</span> <span class="n">__name__</span><span class="p">:</span>
</span><span class='line'>    <span class="n">init</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<!-- more -->


<p>中间我碰到过一个错误<br/>
UnicodeDecodeError: &lsquo;ascii&rsquo; codec can&rsquo;t decode byte 0xe6 in position 204: ordinal not in range(128)<br/>
字符集问题，导致超出长度,所以需要在最前面的地方添加</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="nb">reload</span><span class="p">(</span><span class="n">sys</span><span class="p">)</span>
</span><span class='line'><span class="n">sys</span><span class="o">.</span><span class="n">setdefaultencoding</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>下面这个语句就是产生一个OptionParser的物件，传入2个值，并且通过usage和version定义，这个在使用-h|&mdash;help 会产生效果.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">optParser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">(</span><span class="n">usage</span><span class="o">=</span><span class="n">MSG_USAGE</span><span class="p">,</span><span class="n">version</span><span class="o">=</span><span class="n">MSG_VERSION</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>对optParser增加选项</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">optParser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-u&quot;</span><span class="p">,</span><span class="s">&quot;--username&quot;</span><span class="p">,</span><span class="n">action</span> <span class="o">=</span> <span class="s">&quot;store&quot;</span><span class="p">,</span><span class="nb">type</span> <span class="o">=</span> <span class="s">&quot;string&quot;</span><span class="p">,</span><span class="n">dest</span> <span class="o">=</span> <span class="s">&quot;UserName&quot;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s">&quot;添加数据库用户名(必填)&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>add_option()参数说明:前面2个&#8221;&ldquo;里面的参数是，使用脚本时需要指定的选项<br/>
1.action&mdash;&mdash;是存储方式，分为3种<code>store</code>,<code>store_false</code>,<code>store_true</code>，一般情况下是store,store_false,store_true,都代表参数存在则为true或者false,当false,dest后面的变量将为None</p>

<p>2.type&mdash;&mdash;type代表该option存储dest的形态,支持的形态有string, int,long, choice, float 和 complex,这一块不全部讲，需要用到的时候查看，简单说一个int，如果type使用的是int,那么参数后面（如-u aaa)时，由于aaa不是数字所以type这边就会报错，返回报错信息</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[django 基础]]></title>
    <link href="http://leon8693.github.io/blog/2014/05/15/djangoji-chu/"/>
    <updated>2014-05-15T09:33:00+08:00</updated>
    <id>http://leon8693.github.io/blog/2014/05/15/djangoji-chu</id>
    <content type="html"><![CDATA[<h3>django重点</h3>

<p><code>django-admin.py startproject mysite</code> 命令在当前目录创建一个<code>mysite</code>目录,这个作为一个项目目录</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">mysite</span><span class="o">/</span>
</span><span class='line'><span class="err">├──</span> <span class="n">__init__</span><span class="o">.</span><span class="n">py</span>         <span class="c">#django 初始化模块</span>
</span><span class='line'><span class="err">├──</span> <span class="n">__init__</span><span class="o">.</span><span class="n">pyc</span>
</span><span class='line'><span class="err">├──</span> <span class="n">settings</span><span class="o">.</span><span class="n">py</span>         <span class="c">#django 主要配置,全局环境变量</span>
</span><span class='line'><span class="err">├──</span> <span class="n">settings</span><span class="o">.</span><span class="n">pyc</span>
</span><span class='line'><span class="err">├──</span> <span class="n">urls</span><span class="o">.</span><span class="n">py</span>             <span class="c">#django 主要配置,url跳转</span>
</span><span class='line'><span class="err">├──</span> <span class="n">urls</span><span class="o">.</span><span class="n">pyc</span>
</span><span class='line'><span class="err">├──</span> <span class="n">views</span><span class="o">.</span><span class="n">py</span>            <span class="c">#django 主要配置,视图功能</span>
</span><span class='line'><span class="err">├──</span> <span class="n">views</span><span class="o">.</span><span class="n">pyc</span>
</span><span class='line'><span class="err">├──</span> <span class="n">wsgi</span><span class="o">.</span><span class="n">py</span>             <span class="c">#django 默认加载的模块</span>
</span><span class='line'><span class="err">└──</span> <span class="n">wsgi</span><span class="o">.</span><span class="n">pyc</span>
</span></code></pre></td></tr></table></div></figure>


<p>django请求流程，用户请求&mdash;>django-urls.py&mdash;>django-views.py</p>

<!-- more -->


<h3>settings.py</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#是数据库设置</span>
</span><span class='line'><span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="s">&#39;default&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&#39;ENGINE&#39;</span><span class="p">:</span> <span class="s">&#39;django.db.backends.mysql&#39;</span><span class="p">,</span> <span class="c"># Add &#39;postgresql_psycopg2&#39;, &#39;mysql&#39;, &#39;sqlite3&#39; or &#39;oracle&#39;.</span>
</span><span class='line'>        <span class="s">&#39;NAME&#39;</span><span class="p">:</span> <span class="s">&#39;test&#39;</span><span class="p">,</span>                      <span class="c"># Or path to database file if using sqlite3.</span>
</span><span class='line'>        <span class="s">&#39;USER&#39;</span><span class="p">:</span> <span class="s">&#39;root&#39;</span><span class="p">,</span>                      <span class="c"># Not used with sqlite3.</span>
</span><span class='line'>        <span class="s">&#39;PASSWORD&#39;</span><span class="p">:</span> <span class="s">&#39;123456&#39;</span><span class="p">,</span>                  <span class="c"># Not used with sqlite3.</span>
</span><span class='line'>        <span class="s">&#39;HOST&#39;</span><span class="p">:</span> <span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span>                      <span class="c"># Set to empty string for localhost. Not used with sqlite3.</span>
</span><span class='line'>        <span class="s">&#39;PORT&#39;</span><span class="p">:</span> <span class="s">&#39;3306&#39;</span><span class="p">,</span>                      <span class="c"># Set to empty string for default. Not used with sqlite3.</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c">#需要查看python是否有Mysql模块</span>
</span><span class='line'><span class="n">python</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">MySQLdb</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">test</span><span class="o">=</span><span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="s">&#39;test&#39;</span><span class="p">,</span><span class="n">host</span><span class="o">=</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span><span class="n">user</span><span class="o">=</span><span class="s">&#39;root&#39;</span><span class="p">,</span><span class="n">passwd</span><span class="o">=</span><span class="s">&#39;123456&#39;</span><span class="p">)</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">cur</span><span class="o">=</span><span class="n">test</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;show databases;&#39;</span><span class="p">)</span>
</span><span class='line'><span class="err">即可</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c">#运行命令：python manage.py collectstatic 之后静态文件将要复制到的目录，这个目录只有在运行collectstatic时候才会用到，不能想当然的以为这个目录和MEDIA_ROOT的作用是相同的，否则在开发环境的时候可能一直无法找到静态文件。</span>
</span><span class='line'><span class="n">STATIC_ROOT</span> <span class="o">=</span> <span class="s">&#39;/var/www/html/&#39;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c">#设置的static file的起始url，这个只是在template里边引用到，这个参数和MEDIA_URL的含义相同。</span>
</span><span class='line'><span class="n">STATIC_URL</span> <span class="o">=</span> <span class="s">&#39;/static/&#39;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c">#STATICFILES_DIRS和TEMPLATE_DIRS的含义差不多，就是除了各个app的static目录以外还需要管理的静态文件设置，比如项目的公共文件差不多。</span>
</span><span class='line'><span class="n">STATICFILES_DIRS</span> <span class="o">=</span> <span class="p">(</span>
</span><span class='line'>    <span class="s">&quot;/var/www/html/devops&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&quot;/var/www/html/static&quot;</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c">#INSTALLED_APPS 告诉 Django 项目哪些 app 处于激活状态</span>
</span><span class='line'><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span>
</span><span class='line'>    <span class="s">&#39;django.contrib.auth&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&#39;django.contrib.contenttypes&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&#39;django.contrib.sessions&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&#39;django.contrib.sites&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&#39;django.contrib.messages&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&#39;django.contrib.staticfiles&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&#39;mysite.books&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&#39;django.contrib.admin&#39;</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>django日志设置</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">vim</span> <span class="n">settings</span><span class="o">.</span><span class="n">py</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">logging</span>
</span><span class='line'><span class="c">#添加报错日志，注意/var/log下的权限和uwsgi启动进程的权限是否有</span>
</span><span class='line'><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
</span><span class='line'>          <span class="n">level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
</span><span class='line'>            <span class="n">format</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%(asctime)s</span><span class="s"> </span><span class="si">%(levelname)s</span><span class="s"> </span><span class="si">%(module)s</span><span class="s">.</span><span class="si">%(funcName)s</span><span class="s"> Line:</span><span class="si">%(lineno)d</span><span class="s"> </span><span class="si">%(message)s</span><span class="s">&#39;</span><span class="p">,</span>
</span><span class='line'>              <span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;/var/log/django/django.log&#39;</span><span class="p">,</span>
</span><span class='line'>              <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[awk and sed]]></title>
    <link href="http://leon8693.github.io/blog/2014/05/05/awk-and-sed/"/>
    <updated>2014-05-05T11:05:00+08:00</updated>
    <id>http://leon8693.github.io/blog/2014/05/05/awk-and-sed</id>
    <content type="html"><![CDATA[<h3>AWK</h3>

<p>通过-F分割段落并将输出的内容，以一行2个组成2列</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#文本内容
</span><span class='line'>cat test
</span><span class='line'>"111" : "33333"
</span><span class='line'>"222" : "44444"
</span><span class='line'>"333" : "55555"
</span><span class='line'>"444" : "66666"
</span><span class='line'>
</span><span class='line'>#结果
</span><span class='line'>awk -F'[":]' 'NR%2{printf $5" ";next}{print $5}' test
</span><span class='line'>33333 44444
</span><span class='line'>55555 66666</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[python class]]></title>
    <link href="http://leon8693.github.io/blog/2014/04/25/python/"/>
    <updated>2014-04-25T13:55:00+08:00</updated>
    <id>http://leon8693.github.io/blog/2014/04/25/python</id>
    <content type="html"><![CDATA[<h2>Class</h2>

<h4>1.典型类的调用方法</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#简单类的方式</span>
</span><span class='line'><span class="k">class</span> <span class="nc">myclass</span><span class="p">:</span>                          <span class="c">#定义一个类的名称为myclass</span>
</span><span class='line'>    <span class="s">&quot;this is myclass&quot;</span>                   <span class="c">#定义一个类的说明文档</span>
</span><span class='line'>    <span class="n">a</span><span class="o">=</span><span class="mi">100</span>                               <span class="c">#类的属性,a是成员,可以用类名直接访问</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                 <span class="c">#定义类初始化</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;alex&quot;</span>              <span class="c">#定义name和age属性,并定义方法，必须由类的实例来调用</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="s">&quot;23&quot;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="n">myclass</span><span class="o">.</span><span class="n">a</span>
</span><span class='line'><span class="n">A</span> <span class="o">=</span> <span class="n">myclass</span><span class="p">()</span>                           <span class="c">#实例化类</span>
</span><span class='line'><span class="k">print</span> <span class="n">A</span><span class="o">.</span><span class="n">name</span>                            <span class="c">#类实例化后调用name属性</span>
</span><span class='line'><span class="k">print</span> <span class="n">A</span><span class="o">.</span><span class="n">age</span>
</span></code></pre></td></tr></table></div></figure>


<p>python中<code>self</code>只有在类的方法中才会有，<code>self</code>在定义类的方法时必须有，不需要传入相应参数，<code>self</code>名称也不是必须的，将上面self替换成myname或是任何其他名称也是可以的</p>

<!-- more -->


<h4>2.新类以及动态赋值</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#新类表达方式以及动态调用</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Account</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>                  <span class="c">#在新建Account名字的类时添加object表示属于新类，这个在python2.2版本中引进的,3后面默认是新类</span>
</span><span class='line'>    <span class="s">&quot;一个简单的类&quot;</span>                      <span class="c">#类的说明文档</span>
</span><span class='line'>    <span class="n">account_type</span><span class="o">=</span><span class="s">&quot;Basic&quot;</span>                <span class="c">#你懂的</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">balance</span><span class="p">):</span>    <span class="c">#初始化，并且设定2个属性</span>
</span><span class='line'>        <span class="s">&quot;初始化一个新的Account实例&quot;</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="n">name</span>                  <span class="c">#self.name,self.balance的访问方式访问成员属性</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">balance</span><span class="o">=</span><span class="n">balance</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">deposit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">amt</span><span class="p">):</span>              <span class="c">#设定类中deposit函数</span>
</span><span class='line'>        <span class="s">&quot;存款&quot;</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">balance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">balance</span><span class="o">+</span><span class="n">amt</span>   <span class="c">#设定deposit函数中balance属性获取方式</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">withdraw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">amt</span><span class="p">):</span>
</span><span class='line'>        <span class="s">&quot;取款&quot;</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">balance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">balance</span><span class="o">-</span><span class="n">amt</span>   <span class="c">#设定withdraw函数中balance属性获取方式</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">inquiry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                  <span class="c">#inquiry函数定义最后返回的balance数值</span>
</span><span class='line'>        <span class="s">&quot;返回当前余额&quot;</span>
</span><span class='line'>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">balance</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="n">Account</span><span class="o">.</span><span class="n">account_type</span>
</span><span class='line'><span class="n">A</span><span class="o">=</span><span class="n">Account</span><span class="p">(</span><span class="s">&#39;leon&#39;</span><span class="p">,</span><span class="mi">500</span><span class="p">)</span>                   <span class="c">#实例化类并且赋上默认值</span>
</span><span class='line'><span class="n">A</span><span class="o">.</span><span class="n">deposit</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>                          <span class="c">#函数deposit中对成员amt赋值</span>
</span><span class='line'><span class="n">A</span><span class="o">.</span><span class="n">withdraw</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>                         <span class="c">#函数withdraw中对成员amt赋值</span>
</span><span class='line'><span class="k">print</span> <span class="n">A</span><span class="o">.</span><span class="n">name</span>                            <span class="c">#调用A.name属性</span>
</span><span class='line'><span class="k">print</span> <span class="n">A</span><span class="o">.</span><span class="n">balance</span>                         <span class="c">#调用A.balance属性</span>
</span></code></pre></td></tr></table></div></figure>


<p>python2.7中，必须在新建类时添加<code>object</code>方法来使这个类成为新类，不过在python3以后默认就是新类，新类和旧类相比多些新的属性。
上面例子就是简单的条用方式和赋值方法。</p>

<h4>3.类的class属性</h4>

<p>接上面的类打印class的一些属性</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">B</span><span class="o">=</span><span class="n">Account</span><span class="o">.</span><span class="n">__name__</span>                      <span class="c">#name属性需要实例化后才可调用</span>
</span><span class='line'><span class="n">C</span><span class="o">=</span><span class="n">Account</span><span class="o">.</span><span class="n">__base__</span>                      <span class="c">#base属性需要实例化后才可调用</span>
</span><span class='line'><span class="k">print</span> <span class="n">A</span><span class="o">.</span><span class="n">__doc__</span>                         <span class="c">#类型帮助信息</span>
</span><span class='line'><span class="k">print</span> <span class="n">B</span>                                 <span class="c">#类型名称</span>
</span><span class='line'><span class="k">print</span> <span class="n">A</span><span class="o">.</span><span class="n">__module__</span>                      <span class="c">#类型所在模块</span>
</span><span class='line'><span class="k">print</span> <span class="n">C</span>                                 <span class="c">#类型所继承的基类</span>
</span><span class='line'><span class="k">print</span> <span class="n">A</span><span class="o">.</span><span class="n">__dict__</span>                        <span class="c">#类型字典，存储所有类型成员信息</span>
</span><span class='line'><span class="k">print</span> <span class="n">A</span><span class="o">.</span><span class="n">__class__</span>                       <span class="c">#类型</span>
</span></code></pre></td></tr></table></div></figure>


<h4>小知识</h4>

<p>这个参数定义在开头就可以在python脚本中添加中文注释了</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># -*- coding:utf-8 -* </span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Fastdfs Nginx Lua GraphicsMagick 实时缩略图]]></title>
    <link href="http://leon8693.github.io/blog/2013/12/09/fastdfs-plus-nginx-plus-lua-plus-graphicsmagickshi-shi-suo-lue-tu/"/>
    <updated>2013-12-09T14:50:00+08:00</updated>
    <id>http://leon8693.github.io/blog/2013/12/09/fastdfs-plus-nginx-plus-lua-plus-graphicsmagickshi-shi-suo-lue-tu</id>
    <content type="html"><![CDATA[<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#信息版本</span>
</span><span class='line'>Centos 2.6.32-358.el6.x86_64
</span><span class='line'>FastDFS 4.06
</span><span class='line'>Nginx 1.4.1
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c">#官网下载地址</span>
</span><span class='line'>https://fastdfs.googlecode.com/files/FastDFS_v4.06.tar.gz
</span></code></pre></td></tr></table></div></figure>


<h3>安装FastDFS</h3>

<p>参考<a href="http://leon8693.github.io/blog/2013/11/03/FastDFS-install/">FastDFS install</a></p>

<h3>安装需要的包</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>yum install readline readline-devel perl-ExtUtils-Embed  <span class="c">#lua所需要的包以及后面编译需要的其他模块和库</span>
</span><span class='line'>yum install libjpeg libjpeg-devel libpng libpng-devel giflib giflib-devel freetype freetype-devel  openjpeg openjpeg-devel <span class="c">#gm需要的图库</span>
</span></code></pre></td></tr></table></div></figure>




<!-- more -->


<h3>下载相关的包并安装</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">###graphicsmagick install</span>
</span><span class='line'>wget <span class="s2">&quot;http://sourceforge.net/projects/graphicsmagick/files/graphicsmagick/1.3.16/GraphicsMagick-1.3.16.tar.gz/download&quot;</span>
</span><span class='line'>tar xf GraphicsMagick-1.3.16.tar.gz
</span><span class='line'>./configure --prefix<span class="o">=</span>/usr/local/GraphicsMagick-1.3.16
</span><span class='line'>make <span class="o">&amp;&amp;</span> make install
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c">###nginx 安装方式</span>
</span><span class='line'><span class="c">###LuaJIT install</span>
</span><span class='line'>wget <span class="s2">&quot;http://luajit.org/download/LuaJIT-2.0.0-beta10.tar.gz&quot;</span>
</span><span class='line'>tar xf LuaJIT-2.0.0-beta10.tar.gz
</span><span class='line'><span class="nb">cd </span>tar xf LuaJIT-2.0.0-beta10
</span><span class='line'>make <span class="o">&amp;&amp;</span> make install <span class="nv">PREFIX</span><span class="o">=</span>/usr/local/lj2
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c">###ngx_devel_kit install</span>
</span><span class='line'>wget <span class="s2">&quot;https://github.com/simpl/ngx_devel_kit/zipball/master&quot;</span>
</span><span class='line'>unzip master
</span><span class='line'>ls simpl-ngx_devel_kit-8dd0df5
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c">###lua-nginx-module install</span>
</span><span class='line'>wget <span class="s2">&quot;https://github.com/chaoslawful/lua-nginx-module/tarball/master&quot;</span> -O master-lug-nginx-module.tar.gz
</span><span class='line'>tar xf master-lug-nginx-module.tar.gz
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c">###echo</span>
</span><span class='line'>wget <span class="s2">&quot;https://github.com/agentzh/echo-nginx-module/zipball/master&quot;</span> -O <span class="nb">echo</span>-nginx-module.zip
</span><span class='line'>unzip <span class="nb">echo</span>-nginx-module.zip
</span><span class='line'>
</span><span class='line'><span class="c">###cache</span>
</span><span class='line'>wget <span class="s2">&quot;http://labs.frickle.com/files/ngx_cache_purge-1.6.tar.gz&quot;</span>
</span><span class='line'>tar xf ngx_cache_purge-1.6.tar.gz
</span><span class='line'>
</span><span class='line'><span class="c">###vim /etc/profile</span>
</span><span class='line'><span class="nb">export </span><span class="nv">LUAJIT_LIB</span><span class="o">=</span>/usr/local/lj2/lib
</span><span class='line'><span class="nb">export </span><span class="nv">LUAJIT_INC</span><span class="o">=</span>/usr/local/lj2/include/luajit-2.0
</span><span class='line'><span class="nb">export </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>/usr/local/lib/:<span class="nv">$LD_LIBRARY_PATH</span>
</span><span class='line'><span class="nb">export  </span><span class="nv">PKG_CONFIG_PATH</span><span class="o">=</span>/usr/local/lib/pkgconfig:<span class="nv">$PKG_CONFIG_PATH</span>
</span><span class='line'><span class="nv">GM_HOME</span><span class="o">=</span>/usr/local/GraphicsMagick-1.3.16;
</span><span class='line'><span class="nv">PATH</span><span class="o">=</span><span class="nv">$GM_HOME</span>/bin:<span class="nv">$PATH</span>;
</span><span class='line'><span class="nb">export </span>PATH
</span><span class='line'><span class="nb">export </span>GM_HOME
</span><span class='line'><span class="nb">source</span> /etc/profile
</span></code></pre></td></tr></table></div></figure>


<h3>nginx install</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#安装前必须安装好Fastdfs</span>
</span><span class='line'>./configure --prefix<span class="o">=</span>/usr/share/nginx --sbin-path<span class="o">=</span>/usr/sbin/nginx --conf-path<span class="o">=</span>/etc/nginx/nginx.conf --error-log-path<span class="o">=</span>/var/log/nginx/error.log --http-log-path<span class="o">=</span>/var/log/nginx/access.log --http-client-body-temp-path<span class="o">=</span>/var/lib/nginx/tmp/client_body --http-proxy-temp-path<span class="o">=</span>/var/lib/nginx/tmp/proxy --http-fastcgi-temp-path<span class="o">=</span>/var/lib/nginx/tmp/fastcgi --pid-path<span class="o">=</span>/var/run/nginx.pid --lock-path<span class="o">=</span>/var/lock/subsys/nginx --with-http_ssl_module --with-http_realip_module --with-http_addition_module --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-http_gzip_static_module --with-http_stub_status_module --with-http_perl_module --with-mail --with-mail_ssl_module --add-module<span class="o">=</span>/srv/fastdfs-nginx-module/src/  --add-module<span class="o">=</span>/srv/fastdfs/simpl-ngx_devel_kit-8dd0df5/ --add-module<span class="o">=</span>/srv/fastdfs/ngx_cache_purge-1.6/ --with-http_perl_module --add-module<span class="o">=</span>/srv/fastdfs/agentzh-echo-nginx-module-9f811cf/ --with-ld-opt<span class="o">=</span>-Wl,-rpath,/usr/local/lj2/lib --add-module<span class="o">=</span>/srv/fastdfs/chaoslawful-lua-nginx-module-d11dda1/
</span><span class='line'>
</span><span class='line'>make <span class="o">&amp;&amp;</span> make install
</span></code></pre></td></tr></table></div></figure>


<h3>Nginx 配置</h3>

<h5>这边Fastdfs的配置就不多说了，归档中有</h5>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>server <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>        listen  80;
</span><span class='line'>        server_name     www.test.com;
</span><span class='line'>        access_log      /data1/logs/nginx/test_access.log gzip;
</span><span class='line'>        error_log       /data1/logs/nginx/test_error.log;
</span><span class='line'>
</span><span class='line'>        location /lua1 <span class="o">{</span>
</span><span class='line'>                default_type <span class="s1">&#39;text/plain&#39;</span>;
</span><span class='line'>                content_by_lua <span class="s1">&#39;ngx.say(&quot;hello, lua&quot;)&#39;</span>;
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        location  ~* /g<span class="o">[</span>0-9<span class="o">]</span>/M00/ <span class="o">{</span>
</span><span class='line'>                ngx_fastdfs_module;
</span><span class='line'>                <span class="nb">set</span> <span class="nv">$needCreateImg</span> 0;
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span> !-f <span class="nv">$request_filename</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                        <span class="nb">set</span> <span class="nv">$needCreateImg</span> <span class="s2">&quot;${needCreateImg}1&quot;</span>;
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="nv">$uri</span> ~* <span class="s2">&quot;/g[0-9]/M00/(\w+)/(\w+)/([A-Za-z0-9_-]+).(gif|jpg|jpeg|png).(\d+x\d+).(gif|jpg|jpeg|png)&quot;</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                        <span class="nb">set</span> <span class="nv">$needCreateImg</span> <span class="s2">&quot;${needCreateImg}2&quot;</span>;
</span><span class='line'>                        <span class="nb">set</span> <span class="nv">$conUri</span>     <span class="s2">&quot;/$1/$2/$3.$4.$5.$6&quot;</span>;
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="nv">$needCreateImg</span> <span class="o">=</span> <span class="s2">&quot;012&quot;</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                        <span class="nb">set</span> <span class="nv">$image_root</span> <span class="s2">&quot;/data/images01/data/&quot;</span>;
</span><span class='line'>                        <span class="nb">set</span> <span class="nv">$file</span> <span class="s2">&quot;$image_root$conUri&quot;</span>;
</span><span class='line'>                                rewrite_by_lua <span class="s1">&#39;</span>
</span><span class='line'><span class="s1">                                        local index = string.find(ngx.var.conUri, &quot;([0-9]+)x([0-9]+)&quot;);</span>
</span><span class='line'><span class="s1">                                local originalUri = string.sub(ngx.var.conUri, 0, index-2);</span>
</span><span class='line'><span class="s1">                                local area = string.sub(ngx.var.conUri, index);</span>
</span><span class='line'><span class="s1">                                index = string.find(area, &quot;([.])&quot;);</span>
</span><span class='line'><span class="s1">                                area = string.sub(area, 0, index-1);</span>
</span><span class='line'>
</span><span class='line'><span class="s1">                                function table.contains(table, element)</span>
</span><span class='line'><span class="s1">                                        for _, value in pairs(table) do</span>
</span><span class='line'><span class="s1">                                                if value == element then</span>
</span><span class='line'><span class="s1">                                                        return true</span>
</span><span class='line'><span class="s1">                                                        end</span>
</span><span class='line'><span class="s1">                                                                end</span>
</span><span class='line'><span class="s1">                                                                return false</span>
</span><span class='line'><span class="s1">                                                                end</span>
</span><span class='line'>
</span><span class='line'><span class="s1">                                                                local c = &quot;/usr/local/GraphicsMagick-1.3.16/bin/gm convert &quot; .. ngx.var.image_root ..  originalUri  .. &quot; -thumbnail &quot; .. area .. &quot; - &quot;;</span>
</span><span class='line'><span class="s1">                                local f = assert(io.popen(c, &quot;r&quot;))</span>
</span><span class='line'><span class="s1">                                local s = assert(f:read(&quot;*a&quot;))</span>
</span><span class='line'><span class="s1">                                f:close()</span>
</span><span class='line'><span class="s1">                                ngx.say(s)</span>
</span><span class='line'><span class="s1">                                &#39;</span>;
</span><span class='line'>                        <span class="o">}</span>
</span><span class='line'>                        <span class="nb">alias</span> /data/images01/data/;
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>性能测试</h3>

<p>GraphicsMagick VS Ngx_image_thumb(gd)</p>

<h5>测试图片大小</h5>

<p>大小  名字<br/>
12M 10M.jpg <br/>
1.1M    1M.jpg <br/>
4.5M    5M.jpg</p>

<h5>图片其他信息</h5>

<p><img src="http://leon8693.github.io/images/blog_img/info.png" alt="png_info" /></p>

<h5>测试方式</h5>

<p>Apache ab命令  <br/>
ab -n200 -c 10 url</p>

<h5>图片url</h5>

<p><a href="http://192.168.1.100/g1/M00/00/00/CgoDBFKoIMqAIippABCLd5b4wbs388.jpg">http://192.168.1.100/g1/M00/00/00/CgoDBFKoIMqAIippABCLd5b4wbs388.jpg</a> (1.1M)<br/>
<a href="http://192.168.1.100/g1/M00/00/00/CgoDBVKoJhuAJtQfAEaYyGoiMsc873.jpg">http://192.168.1.100/g1/M00/00/00/CgoDBVKoJhuAJtQfAEaYyGoiMsc873.jpg</a> (4.5M) <br/>
<a href="http://192.168.1.100/g1/M00/00/00/CgoDBFKoJl-ALBVOALTeZd_Vsio409.jpg">http://192.168.1.100/g1/M00/00/00/CgoDBFKoJl-ALBVOALTeZd_Vsio409.jpg</a> (12M)</p>

<h5>服务器信息</h5>

<p>DELL R420 <br/>
Intel Xeon E5-2403*1 @1.80GHz <br/>
MEM 32G</p>

<h3>Ngx_image_thumb测试</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ab -n200 -c10 <span class="s1">&#39;http://192.168.1.100/g1/M00/00/00/CgoDBFKoIMqAIippABCLd5b4wbs388.jpg!t300x300.jpg&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>CPU load average: 2.35, 0.53, 0.18 <br/>
MEM 8706M  <br/>
ab详细信息 <br/>
<img src="http://leon8693.github.io/images/blog_img/gd1.png" alt="gd1" /></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ab -n200 -c10 <span class="s1">&#39;http://192.168.1.100/g1/M00/00/00/CgoDBVKoJhuAJtQfAEaYyGoiMsc873.jpg!t300x300.jpg&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>CPU load average: 3.30, 0.88, 0.35 <br/>
MEM 8689M  <br/>
ab详细信息 <br/>
<img src="http://leon8693.github.io/images/blog_img/gd5.png" alt="gd5" /></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ab -n200 -c10 <span class="s1">&#39;http://192.168.1.100/g1/M00/00/00/CgoDBFKoJl-ALBVOALTeZd_Vsio409.jpg!t300x300.jpg&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>CPU load average: 3.61, 1.21, 0.54 <br/>
MEM 8743M <br/>
ab详细信息 <br/>
<img src="http://leon8693.github.io/images/blog_img/gd10.png" alt="gd10" /></p>

<h3>lua graphicsmagick测试</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ab -n200 -c10 <span class="s1">&#39;http://192.168.1.100/g1/M00/00/00/CgoDBFKoIMqAIippABCLd5b4wbs388.jpg.300x300.jpg&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>CPU load average: 1.54, 0.33, 0.11 <br/>
MEM 3M  <br/>
ab详细信息 <br/>
<img src="http://leon8693.github.io/images/blog_img/gm1.png" alt="gm1" /></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ab -n200 -c10 <span class="s1">&#39;http://192.168.1.100/g1/M00/00/00/CgoDBVKoJhuAJtQfAEaYyGoiMsc873.jpg.300x300.jpg&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>CPU load average: 3.66, 0.91, 0.35  <br/>
MEM 1M  <br/>
ab 详细信息  <br/>
<img src="http://leon8693.github.io/images/blog_img/gm5.png" alt="gm5" /></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ab -n200 -c10 <span class="s1">&#39;http://192.168.1.100/g1/M00/00/00/CgoDBFKoJl-ALBVOALTeZd_Vsio409.jpg.300x300.jpg&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>CPU load average: 3.76, 1.35, 0.58  <br/>
MEM 1M  <br/>
ab 详细信息 <br/>
<img src="http://leon8693.github.io/images/blog_img/gm10.png" alt="gm10" /></p>

<h3>性能测试总结</h3>

<p>从上面的测试情况来看,lua+graphicsmagick完爆Ngx_image_thumb <br/>
1.CPU压力相同。 <br/>
2.MEM Ngx_image_thumb不释放，只有重启nginx后才会释放，而Lua+graphicsmagick使用的时候连接一旦释放内存也会释放。 <br/>
3.吞吐量以及请求时间,lua+graphicsmagick完爆Ngx_image_thumb</p>

<h3>问题注意</h3>

<p>我在使用graphicsmagick时候发现一台机器是可以对jpeg进行缩略图，一台则不行。<br/>
通过gm version 查看到原来里面的jpeg功能没有打开，这个需要在编译graphicsmagick前系统就得有libjpeg这个包。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Feature Support:
</span><span class='line'>  Thread Safe              yes
</span><span class='line'>  Large Files <span class="o">(</span>&gt; 32 bit<span class="o">)</span>   yes
</span><span class='line'>  Large Memory <span class="o">(</span>&gt; 32 bit<span class="o">)</span>  yes
</span><span class='line'>  BZIP                     yes
</span><span class='line'>  DPS                      no
</span><span class='line'>  FlashPix                 no
</span><span class='line'>  FreeType                 yes
</span><span class='line'>  Ghostscript <span class="o">(</span>Library<span class="o">)</span>    no
</span><span class='line'>  JBIG                     no
</span><span class='line'>  JPEG-2000                no
</span><span class='line'>  JPEG                     yes
</span><span class='line'>  Little CMS               no
</span><span class='line'>  Loadable Modules         no
</span><span class='line'>  OpenMP                   yes <span class="o">(</span>200805<span class="o">)</span>
</span><span class='line'>  PNG                      yes
</span><span class='line'>  TIFF                     no
</span><span class='line'>  TRIO                     no
</span><span class='line'>  UMEM                     no
</span><span class='line'>  WMF                      no
</span><span class='line'>  X11                      yes
</span><span class='line'>  XML                      yes
</span><span class='line'>  ZLIB                     yes
</span><span class='line'>
</span><span class='line'>Host <span class="nb">type</span>: x86_64-unknown-linux-gnu
</span><span class='line'>
</span><span class='line'>Configured using the <span class="nb">command</span>:
</span><span class='line'>  ./configure  <span class="s1">&#39;--prefix=/usr/local/GraphicsMagick-1.3.16/&#39;</span> --enable-ltdl-convenience
</span><span class='line'>
</span><span class='line'>Final Build Parameters:
</span><span class='line'>  <span class="nv">CC</span>       <span class="o">=</span> gcc -std<span class="o">=</span>gnu99
</span><span class='line'>  <span class="nv">CFLAGS</span>   <span class="o">=</span> -fopenmp -g -O2 -Wall -pthread
</span><span class='line'>  <span class="nv">CPPFLAGS</span> <span class="o">=</span> -I/usr/include/freetype2 -I/usr/include/libxml2
</span><span class='line'>  <span class="nv">CXX</span>      <span class="o">=</span> g++
</span><span class='line'>  <span class="nv">CXXFLAGS</span> <span class="o">=</span> -pthread
</span><span class='line'>  <span class="nv">LDFLAGS</span>  <span class="o">=</span> -L/usr/lib -L/usr/lib
</span><span class='line'>  <span class="nv">LIBS</span>     <span class="o">=</span> -lfreetype -ljpeg -lpng12 -lXext -lSM -lICE -lX11 -lbz2 -lxml2 -lz -lm -lgomp -lpthread
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
</feed>
